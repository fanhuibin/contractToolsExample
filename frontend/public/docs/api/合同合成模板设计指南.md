# 合同合成模板设计指南

## 📚 文档导航

- [智能合同合成 - API版本 文档](./智能合同合成-API版本-API文档.md) — 接口定义与请求/响应格式
- 本文档 — 讲解在线设计模块、设计原理、自定义字段配置
- [集成智能合同合成](./集成智能合同合成.md) — 讲如何调用合成、构建请求 JSON、下载结果

---

## 🎯 模块定位与架构

在线设计模块基于 OnlyOffice 编辑器，通过 iframe 嵌入的方式向业务系统提供 Word 模板设计能力。核心概念：

- **模板设计器**：可视化插入 ContentControl（SDT）字段、设置样式、保存模板
- **模板服务**：接受设计器保存的文件与元素清单，存储 DOCX 及 `elementsJson`
- **字段配置中心**：通过 JSON 配置或接口提供可插入字段列表，保证字段命名统一
- **合成引擎**：加载模板、填充 `values`、合并 PDF、盖章

设计阶段的产出是：

1. 模板 DOCX 文件（含 ContentControl）
2. 模板元素元数据（`elementsJson`），包含每个字段的 `tag`、`code`、`type` 等信息

---

## 🛠️ 设计流程总览

1. **创建模板记录**
   - 通过 API 或控制台创建模板元数据（名称、编号、描述等）
2. **上传初始 DOCX（可选）**
   - 若已有基础文档，可先上传，便于在设计器中继续编辑
3. **打开在线设计器**
   - 通过 iframe 或新窗口打开设计器地址，传入 `templateId`
4. **插入字段**
   - 从“要素面板”选择字段，插入到文档指定位置（推荐使用块级 ContentControl）
5. **保存模板**
   - 设计器会调用后端保存接口，生成最新版本的 DOCX 与 `elementsJson`
6. **发布模板**
   - 在管理后台或通过 API 将模板状态设置为 `PUBLISHED`，供合成使用

> ⚠️ **注意**：模板发布后若需修改，应先复制或创建新版，保持历史版本可追溯。

---

## 📑 ContentControl 字段体系

字段由设计器从后台获取，按照业务分类展示。核心属性：

| 字段属性 | 说明 | 示例 |
|----------|------|------|
| `tag` | Word 中的 ContentControl 标记，合成 `values` 的 key | `tagElementbase_contractCode_1762826537996_2xuxwr` |
| `code` | 业务含义/短名称，便于配置和搜索 | `base_contractCode` |
| `type` | 字段类型：`text`、`clause`、`table`、`seal` 等 | `seal` |
| `meta` | 额外元数据，例如默认文本、样式、是否必填 | `{ required: true }` |

### 字段分类

| 分类 | 说明 | 典型用途 |
|------|------|----------|
| `baseFields` | 合同基础信息 | 合同编号、签署地点、金额等 |
| `counterpartyFields` | 相对方信息 | 甲乙方名称、地址、证照号码 |
| `clauseFields` | 条款类字段，通常为富文本 | 付款条款、违约条款（支持HTML格式，包括高亮、颜色等） |
| `sealFields` | 印章字段（普通章） | 甲方公章、乙方公章 |

### 富文本字段样式支持

条款类字段（`clauseFields`）支持丰富的HTML样式，包括：

- **文本格式**：粗体 `<b>`、斜体 `<i>`、下划线 `<u>`、删除线 `<s>`
- **文字颜色**：`<span style="color: red;">红色文字</span>`
- **背景色/高亮**：
  - `<mark>默认黄色高亮</mark>`
  - `<mark style="background-color: #ff9800;">自定义颜色高亮</mark>`
  - `<span style="background-color: #ffeb3b;">黄色背景</span>`
- **上标/下标**：`H<sub>2</sub>O`、`x<sup>2</sup>`
- **表格**：支持完整的HTML表格语法

> 💡 **使用场景示例**：
> - 条款中的重要内容使用 `<mark>` 标签高亮显示
> - 关键数字或金额使用醒目颜色 `<span style="color: #f56c6c; font-weight: bold;">1,000,000元</span>`
> - 法律条款中的免责声明可以用浅灰背景区分 `<span style="background-color: #f5f5f5; padding: 4px;">免责声明：...</span>`

### 印章字段设计要点

- 在模板中插入印章字段（type=`seal`），合成时系统会自动在该位置盖普通章
- 字段的 `tag` 将用于 `stampImageUrls` 的 key；请勿手动修改 tag
- 骑缝章不依赖字段，不需要在模板中插入特殊标记

---

## 🧩 自定义字段配置

为保证不同业务线可以定制字段列表，系统支持两类配置方式：

### 1. 本地 JSON 配置（内置）

- 文件位置：`contract-tools-sdk/testuploads/template/fields.json`
- 结构：
  ```json
  {
    "baseFields": [
      { "id": "1", "name": "合同编号", "code": "base_contractCode", "isRichText": false }
    ],
    "counterpartyFields": [],
    "clauseFields": [
      {
        "id": "10",
        "name": "付款条款",
        "code": "clause_payment",
        "isRichText": true,
        "content": "<p>付款方式：<mark>合同签订后30天内付款</mark></p><p>付款账号：<span style='background-color: #e3f2fd;'>请填写收款账号</span></p>"
      }
    ],
    "sealFields": []
  }
  ```
  
> 💡 **富文本字段提示**：
> - `clauseFields` 中的字段建议设置 `isRichText: true`
> - `content` 字段可包含HTML格式，支持 `<mark>` 标签、背景色、颜色等样式
> - 使用高亮标记重要信息，提高模板的可读性
- 启动时由 `TemplateServiceImpl` 加载，并经过 `FieldConfigValidator` 校验：
  - 四大类数组必须存在（可为空）
  - `id` / `name` / `code` 必填且长度≤100
  - `code` 需字母开头，仅包含字母、数字、下划线
  - `sealFields` 必须声明 `type`
  - `clauseFields` 必须提供 `content`
  - `counterpartyFields` 需填写 `counterpartyIndex`

### 2. 第三方字段接口（推荐）

- 设计器支持通过 URL 参数 `fieldsConfigUrl` 拉取字段配置
- 该接口由业务方实现，返回结构同上，便于按模板类型动态下发
- 优点：字段更新实时生效、无文件同步风险、支持多租户差异化

> 💡 **最佳实践**：在接口中加入 `required`、`placeholder`、`meta` 等自定义属性，可在设计器中展示提示信息。

---

## 🧪 设计阶段校验

系统在保存模板时会执行以下校验：

1. **字段合法性**：通过 `FieldConfigValidator.validateJsonConfig` 检查字段结构
2. **重复校验**：`id` / `code` 跨类别唯一，避免数据覆盖
3. **富文本预览**：条款字段的默认内容会在设计器中渲染，帮助检查格式
4. **占位符建议**：建议为每个字段设置提示文本，便于合成阶段识别空值

若校验失败，设计器会提示具体原因，阻止模板保存。

---

## 🔍 模板元素数据（`elementsJson`）

模板保存后，后端会生成 `elementsJson`，格式示例：

```json
{
  "elements": [
    {
      "tag": "tagElementbase_contractCode_1762826537996_2xuxwr",
      "code": "base_contractCode",
      "displayName": "合同编号",
      "type": "text",
      "meta": { "required": true }
    },
    {
      "tag": "tagElementseal_party_a_1762827325581_rjhjvg",
      "code": "seal_party_a",
      "displayName": "甲方公章",
      "type": "seal"
    }
  ]
}
```

用途：

- 合成阶段获取所有字段 `tag`，构建 `values`
- 前端在“查看元素”界面中展示字段列表
- 校验必填字段、富文本模板、印章字段等

---

## 🧭 设计器对接方式

### 1. iframe 嵌入（推荐）

```html
<iframe
  src="https://editor.example.com/templates/design?templateId=123&fieldsConfigUrl=https%3A%2F%2Fyour-app.com%2Fapi%2Ffields%3Ftype%3Dpurchase"
  width="100%"
  height="820"
  frameborder="0"
></iframe>
```

> - `templateId`：模板唯一标识
> - `fieldsConfigUrl`：自定义字段接口地址（URL 编码）

### 2. 新窗口打开

适合管理后台在独立页设计，避免 iframe 高度受限。URL 参数与 iframe 相同。

### 3. 权限控制

- 打开设计器前请校验当前用户是否有模板编辑权限
- 可通过在 URL 上附带 auth token 或使用 SSO 方案保障安全

---

## 🗂️ 模板版本与发布策略

- **草稿 (DRAFT)**：默认状态，可随时修改
- **已发布 (PUBLISHED)**：合成引擎默认只使用已发布版本
- **版本号管理**：模板保存时可指定 `version`，建议遵循语义化版本（如 1.0、1.1）
- **更新流程**：
  1. 从已发布模板复制出新版本
  2. 在设计器中修改并保存
  3. 测试合成结果（推荐使用测试环境）
  4. 将新版本发布上线

> ⚠️ **提示**：不要直接修改生产已发布模板，以免影响正在运行的合同。

---

## 🔗 关键接口

| 接口 | 说明 | 备注 |
|------|------|------|
| `POST /api/template/design/upload` | 上传 DOCX 模板 | 设计器内部调用 |
| `POST /api/template/design/save` | 保存模板设计（包含 `elementsJson`） | 设计器内部调用 |
| `GET /api/template/design/{id}` | 查询模板详情（含版本、状态） | 管理后台使用 |
| `GET /api/template/design/list` | 列出模板 | 支持状态筛选 |
| `GET /api/templates/{id}/elements` | 获取模板元素列表 | 用于“查看元素”界面 |

详细的请求/响应格式请参考 [智能合同合成 - API版本 文档](./智能合同合成-API版本-API文档.md)。

---

## ✅ 设计阶段最佳实践

1. **字段命名规范**
   - 使用具备业务意义的 `code`，例如 `base_contractCode`
   - 避免 `field1`、`dataA` 这类无法识别的名称
2. **占位符文本**
   - 在 ContentControl 中填写提示文字，例如"请填写合同编号"
3. **块级内容控件**
   - 条款、表格等富文本部分请使用块级控件，避免嵌套在表格单元格内
4. **富文本样式使用**
   - ✅ 使用 `<mark>` 标签突出重要条款和关键信息
   - ✅ 用背景色区分不同类型的内容（如 `<span style="background-color: #e3f2fd;">提示信息</span>`）
   - ✅ 组合使用颜色和粗体强调金额、日期等关键数据
   - ⚠️ 避免过度使用高亮，建议高亮内容不超过文档的10%
   - ⚠️ 选择浅色背景（如黄色、浅蓝色），深色背景需搭配浅色文字
5. **测试数据**
   - 设计阶段多次保存并在测试环境合成，确保格式、分页、字体符合预期
   - 测试不同长度的文本和表格数据，验证样式在各种场景下的表现
6. **印章位置**
   - 留出充足空间放置印章，避免遮挡正文
7. **版本备份**
   - 在重大修改前导出 DOCX 作为备份，便于回滚

---

## ❓ 常见问题

### Q1: 字段面板中看不到自定义字段？
- 确认 `fields.json` 或 `fieldsConfigUrl` 返回的结构符合校验规则
- 检查接口返回是否包含四大字段分类（即便为空也需返回空数组）
- 查看日志中 `FieldConfigValidator` 的校验报错

### Q2: 模板保存后合成接口报“values 缺少字段”？
- 请在合成前调用模板详情或元素列表接口，获取最新的 `tag`
- 合成 JSON 中的 key 必须是 `tag`，不要使用 `code`

### Q3: 条款字段的默认 HTML 显示异常？
- 设计器中的条款内容建议使用简单 HTML 标签，避免外部复制时带入多余样式
- 合成前可通过预览接口检查最终渲染效果

### Q3.5: 如何在条款中使用背景色和高亮？
- 使用 `<mark>` 标签标记重要内容：`<mark>重要条款</mark>`
- 使用 CSS 样式自定义背景色：`<span style="background-color: #ffeb3b;">高亮文本</span>`
- 推荐颜色：
  - 黄色高亮：`#ffeb3b`（用于一般强调）
  - 浅蓝色：`#e3f2fd`（用于提示信息）
  - 浅橙色：`#fff3cd`（用于警告）
- 注意事项：
  - 避免过度使用高亮（建议不超过10%的内容）
  - 深色背景需搭配浅色文字以保证可读性
  - 测试打印效果，确保背景色在打印时清晰可见

**示例**：
```html
<p>付款条件：</p>
<p>1. <mark>合同签订后7日内</mark>支付预付款；</p>
<p>2. 货物验收合格后，<mark>15日内</mark>支付尾款。</p>
<p style="background-color: #e3f2fd; padding: 8px;">
  💡 提示：逾期付款将收取违约金。
</p>
```

### Q4: 印章字段未正确盖章？
- 确认模板中对应字段的 `type` 为 `seal`
- 合成请求的 `stampImageUrls` key 是否与 `tag` 完全一致
- 图片地址需要可访问，建议使用 HTTPS

### Q5: 如何限制设计器可插入字段？
- 在 `fieldsConfigUrl` 接口中仅返回允许字段
- 可根据用户角色、模板类型动态调整返回结果

---

## 📞 技术支持

- 📧 官方网站：[https://zhaoxinms.com](https://zhaoxinms.com)
- 📦 产品价格：[https://zhaoxinms.com/price](https://zhaoxinms.com/price)

---

> 📌 阅读顺序建议：先了解本指南 → 在设计器中完成模板 → 再阅读 [集成智能合同合成](./集成智能合同合成.md) 完成合成对接。


