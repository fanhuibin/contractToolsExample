# 集成智能合同合成

## 📚 文档导航

- [智能合同合成 - API版本 文档](./智能合同合成-API版本-API文档.md)：接口定义、请求与响应
- [合同合成模板设计指南](./合同合成模板设计指南.md)：在线设计模块、字段体系、自定义字段
- 本文档：合成原理、获取模板字段、构建合成 JSON、盖章与下载流程

---

## 📘 文档范围

本文聚焦 **“如何调用合成引擎”**，涵盖以下主题：

1. 合同合成整体架构与流程
2. 如何获取模板字段信息（接口查询、界面查看元素）
3. 如何构建合成请求 JSON（`values`、`stampImageUrls`、`extraFiles`、`ridingStampUrl`）
4. 合成成功后的下载、预览与批量处理
5. 错误处理、性能优化与常见问题

> 💡 模板设计、字段配置、设计器接入请参考《合同合成模板设计指南》。

---

## 📚 概述

智能合同合成功能允许通过可视化设计合同模板，然后通过数据驱动的方式动态生成合同文档。本文档介绍如何将此功能集成到你的系统中（合成视角）。

> 💡 **关于示例代码**：本文档中的代码示例默认基于 **Java + Vue3** 技术栈，这也是我们推荐的技术组合。但请注意，**我们的 API 是语言无关的**，你可以使用任何语言（Python、PHP、.NET、Go 等）和任何前端框架（React、Angular 等）进行集成。我们提供 Java 示例仅作为参考。

## 🎯 核心功能

- ✅ **模板设计器**：可视化设计合同模板（基于 OnlyOffice）
- ✅ **ContentControl 支持**：支持 Word ContentControl 内容控件
- ✅ **富文本内容**：支持 HTML 格式的富文本填充
- ✅ **表格支持**：支持动态表格数据填充
- ✅ **样式继承**：自动继承模板样式
- ✅ **批量生成**：支持批量合成多份合同

## 📋 推荐集成方案

### ⭐ 推荐方案：自建管理 + iframe 设计器 + API 合成（最佳实践）

**我们强烈建议采用以下集成方式：**

1. **模板管理**：自己实现
   - ✅ 在你的系统中实现模板列表界面
   - ✅ 通过 API 创建、查询、删除模板
   - ✅ 同步在我们系统中创建模板记录
   - ✅ 完全控制模板的组织和权限

2. **模板设计**：使用我们的设计器（iframe 嵌入）
   - ✅ 专业的可视化设计界面（基于 OnlyOffice）
   - ✅ 可视化插入 ContentControl 字段
   - ✅ 实时预览和测试
   - ✅ 无需开发复杂的设计器UI
   - ⚠️ **不要自己开发设计器**（涉及 ContentControl 操作等复杂功能）

3. **合同合成**：使用 API 调用
   - ✅ 灵活控制合成流程
   - ✅ 批量合成支持
   - ✅ 自定义下载和预览逻辑

### 集成流程图

```
你的系统                    我们的系统
┌─────────────────┐        ┌─────────────────┐
│ 模板列表页面     │ ──API─→ │ 创建模板记录     │
│ (自己实现)      │        │                 │
└─────────────────┘        └─────────────────┘
         ↓                          ↓
┌─────────────────┐        ┌─────────────────┐
│ 点击"设计模板"  │ ─iframe→│ 模板设计器       │
│                 │        │ (OnlyOffice)    │
└─────────────────┘        └─────────────────┘
         ↓                          ↓
┌─────────────────┐        ┌─────────────────┐
│ 点击"生成合同"  │ ──API─→ │ 合同合成引擎     │
│                 │        │                 │
└─────────────────┘        └─────────────────┘
         ↓
┌─────────────────┐
│ 下载/预览合同    │
│ (API调用)       │
└─────────────────┘
```

### 方案对比

| 集成方式 | 模板管理 | 模板设计 | 合同合成 | 推荐指数 |
|---------|---------|---------|---------|---------|
| **推荐方案** | 自己实现 | iframe 嵌入 | API 调用 | ⭐⭐⭐⭐⭐ |
| **完全 iframe** | iframe 嵌入 | iframe 嵌入 | iframe 嵌入 | ⭐⭐⭐ |
| **完全 API** | 自己实现 | 自己开发 | API 调用 | ⭐ (不推荐) |

---

## 📖 集成步骤（推荐方案）

### 步骤1：实现模板管理界面

在你的系统中创建模板列表页面：


### 步骤2：嵌入模板设计器

当用户点击"设计模板"时，使用 iframe 嵌入我们的设计器：

```html
<!DOCTYPE html>
<html>
<head>
  <title>设计合同模板</title>
</head>
<body>
  <div class="designer-container">
    <div class="toolbar">
      <button onclick="goBack()">返回列表</button>
      <span>正在设计：采购合同模板</span>
    </div>
    
    <!-- 嵌入我们的设计器 -->
    <iframe 
      id="templateDesigner"
      src="http://your-domain:3000/templates/design?templateId=xxx"
      width="100%"
      height="800px"
      frameborder="0"
      style="border: 1px solid #dcdfe6; border-radius: 4px;"
    ></iframe>
  </div>
  
  <script>
    function goBack() {
      // 返回模板列表
      window.location.href = '/templates';
    }
  </script>
</body>
</html>
```

> 💡 **提示**：设计器中的"保存"按钮会自动保存模板，无需在外部页面处理保存逻辑。

---

### 📋 自定义可插入元素

设计器支持自定义可插入的字段列表。通过 URL 参数传递自定义字段，你可以完全控制用户能插入哪些字段到模板中。

#### 为什么需要自定义元素？

- ✅ **业务定制**：不同行业、不同合同类型需要不同的字段
- ✅ **字段控制**：只显示用户需要的字段，隐藏不相关的字段
- ✅ **命名统一**：使用你自己系统的字段命名规范

#### 快速示例

```javascript
// 1. 在你的系统中提供一个配置接口
// GET http://your-system.com/api/get-fields-config?templateType=purchase
// 返回：
// {
//   "baseFields": [...],
//   "clauseFields": [...],
//   "counterpartyFields": [...],
//   "sealFields": [...]
// }

// 2. 构建设计器 URL（URL 只传接口地址）
const fieldsConfigUrl = encodeURIComponent(
  'http://your-system.com/api/get-fields-config?templateType=purchase'
);

const designerUrl = `http://editor-domain:3000/templates/design?templateId=${templateId}&fieldsConfigUrl=${fieldsConfigUrl}`;

// 3. 嵌入设计器
document.getElementById('designer-frame').src = designerUrl;

// 或者直接在 HTML 中：
// <iframe src="http://editor-domain:3000/templates/design?templateId=xxx&fieldsConfigUrl=http%3A%2F%2Fyour-system.com%2Fapi%2Fget-fields-config"></iframe>
```

> 📖 **详细说明**：
> - 完整的实现步骤、接口格式、示例代码请查看 [自定义元素使用指南](./自定义元素使用指南.md)
> - **推荐使用"用户接口"方式**：参考 OnlyOffice 设计，URL 无长度限制，配置完全由用户系统管理
> - **优势**：无需上传配置，实时更新，支持无限字段数量

---

### 🔍 查看模板元素

设计完成后，你可能需要知道模板中插入了哪些字段，以便在合成时提供对应的数据。

#### 方法1：通过 API 查询（推荐）

```javascript
// 查询模板已插入的元素
async function getTemplateElements(templateId) {
  const response = await fetch(`http://your-domain:8080/api/templates/${templateId}/elements`);
  const result = await response.json();
  
  if (result.success) {
    const elements = result.data;
    console.log('模板元素列表:', elements);
    
    // 元素数据结构示例：
    // [
    //   { code: 'contract_no', name: '合同编号', type: 'text' },
    //   { code: 'amount', name: '合同金额', type: 'text' },
    //   { code: 'items', name: '商品明细', type: 'table' }
    // ]
    
    return elements;
  }
}

// 根据元素列表生成合同数据
function generateContractData(elements) {
  const data = {};
  
  elements.forEach(element => {
    if (element.type === 'text') {
      data[element.code] = '待填充的值';
    } else if (element.type === 'table') {
      data[element.code] = '<table>...</table>';
    }
  });
  
  return data;
}
```

#### 方法2：使用"查看元素"界面

如果你使用我们的模板管理界面，可以直接点击"查看元素"按钮：

#### 元素信息说明

查看元素功能会返回以下信息：

| 字段 | 说明 | 示例 |
|------|------|------|
| `code` | 字段编码（用于数据绑定） | `contract_no` |
| `name` | 字段名称（显示名） | `合同编号` |
| `type` | 字段类型 | `text` / `table` / `image` |
| `category` | 字段分类 | `base` / `clause` / `party` / `seal` |
| `insertedAt` | 插入时间 | `2025-11-05 18:00:00` |

#### 完整示例：从查看元素到合成合同

```javascript
// 完整流程示例
async function composeContractFlow(templateId) {
  // 1. 查询模板元素
  const elements = await getTemplateElements(templateId);
  console.log('模板需要的字段:', elements);
  
  // 2. 根据元素准备数据
  const contractData = {
    // 基础字段
    contract_no: 'GY-2025-001',
    contract_name: '采购合同',
    sign_date: '2025年11月5日',
    
    // 条款字段
    payment_terms: '合同签订后30天内付款',
    
    // 相对方字段
    party_a_name: '北京某某科技有限公司',
    party_b_name: '上海某某贸易有限公司',
    
    // 表格字段
    items: `
      <table>
        <tr><th>商品名称</th><th>数量</th><th>单价</th></tr>
        <tr><td>商品A</td><td>10</td><td>100.00</td></tr>
      </table>
    `
  };
  
  // 3. 调用合成 API（推荐使用模板编号）
  const response = await fetch('http://your-domain:8080/api/compose/sdt', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      templateCode: 'purchase_contract',  // 使用模板编号（推荐）
      values: contractData  // 注意：字段名是 values，不是 data
    })
  });
  
  const result = await response.json();
  if (result.success) {
    console.log('合成成功，文件ID:', result.data.fileId);
    
    // 4. 下载合同
    downloadContract(result.data.fileId);
  }
}
```

---

### 步骤3：使用 API 合成合同

```javascript
// 准备合同数据
const contractData = {
  "contractNo": "GY-2025-001",
  "contractName": "采购合同",
  "partyA": "北京某某科技有限公司",
  "partyB": "上海某某贸易有限公司",
  "amount": "1,000,000.00",
  "signDate": "2025年11月5日",
  "items": `
    <table style="width:100%; border-collapse:collapse;">
      <tr style="background:#409eff; color:#fff;">
        <th style="border:1px solid #dcdfe6; padding:8px;">序号</th>
        <th style="border:1px solid #dcdfe6; padding:8px;">商品名称</th>
        <th style="border:1px solid #dcdfe6; padding:8px;">数量</th>
        <th style="border:1px solid #dcdfe6; padding:8px;">单价</th>
        <th style="border:1px solid #dcdfe6; padding:8px;">金额</th>
      </tr>
      <tr>
        <td style="border:1px solid #dcdfe6; padding:8px;">1</td>
        <td style="border:1px solid #dcdfe6; padding:8px;">笔记本电脑</td>
        <td style="border:1px solid #dcdfe6; padding:8px;">10</td>
        <td style="border:1px solid #dcdfe6; padding:8px;">8,000.00</td>
        <td style="border:1px solid #dcdfe6; padding:8px;">80,000.00</td>
      </tr>
    </table>
  `
};

// 调用合成API（推荐使用模板编号）
async function composeContract(templateCode, data, extraFiles = null, stampImageUrls = null, ridingStampUrl = null) {
  const requestBody = {
    templateCode: templateCode,  // 使用模板编号（推荐）
    values: data  // 注意：字段名是 values，不是 data
  };
  
  // 如果需要合并额外PDF文件
  if (extraFiles && extraFiles.length > 0) {
    requestBody.extraFiles = extraFiles;
  }
  
  // 如果需要盖普通章
  if (stampImageUrls) {
    requestBody.stampImageUrls = stampImageUrls;
  }
  
  // 如果需要盖骑缝章（独立参数）
  if (ridingStampUrl) {
    requestBody.ridingStampUrl = ridingStampUrl;
  }
  
  const response = await fetch('http://your-domain:8080/api/compose/sdt', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(requestBody)
  });
  
  const result = await response.json();
  
  if (result.code === 200 || result.success) {
    return result.data.fileId;
  } else {
    throw new Error(result.message || '合成失败');
  }
}

// 示例：合成合同并合并附件PDF，然后盖骑缝章
async function composeContractWithAttachments() {
  const templateCode = 'purchase_contract';
  
  // 1. 获取模板信息，提取tag
  const templateInfo = await getTemplateInfo(templateCode);
  const elements = JSON.parse(templateInfo.elementsJson).elements;
  
  // 2. 构建values（使用tag作为key）
  const contractData = {};
  elements.forEach(el => {
    if (el.type !== 'seal') { // 印章字段的value由系统生成
      // 根据字段的code设置值（示例）
      if (el.meta?.code === 'base_contractCode') {
        contractData[el.tag] = 'GY-2025-001';
      } else if (el.meta?.code === 'party_a_name') {
        contractData[el.tag] = '北京某某科技有限公司';
      } else if (el.meta?.code === 'party_b_name') {
        contractData[el.tag] = '上海某某贸易有限公司';
      }
    }
  });
  
  // 需要合并的附件PDF文件URL列表
  const extraFiles = [
    'https://example.com/contracts/technical_spec.pdf',
    'https://example.com/contracts/price_list.pdf'
  ];
  
  // 1. 获取模板信息，识别印章字段
  const templateInfo = await getTemplateInfo(templateCode);
  const elements = JSON.parse(templateInfo.elementsJson).elements;
  
  // 2. 找出所有印章字段（type === "seal"）
  const sealElements = elements.filter(el => el.type === 'seal');
  
  // 3. 构建普通章图片URL映射（key为tag）
  const stampImageUrls = {};
  sealElements.forEach(seal => {
    stampImageUrls[seal.tag] = {
      normal: `https://example.com/stamps/${seal.meta.code}.png`
    };
  });
  // 示例结果：
  // {
  //   "tagElementseal_party_a_1762827325581_rjhjvg": {
  //     "normal": "https://example.com/stamps/seal_party_a.png"
  //   },
  //   "tagElementseal_party_b_1762827344941_0yfagr": {
  //     "normal": "https://example.com/stamps/seal_party_b.png"
  //   }
  // }
  
  // 4. 骑缝章图片URL（独立参数，可选，不绑定任何字段）
  const ridingStampUrl = 'https://example.com/stamps/riding_seal.png';
  
  const fileId = await composeContract(templateCode, contractData, extraFiles, stampImageUrls, ridingStampUrl);
  console.log('合同合成成功，文件ID:', fileId);
  
  // 下载合同
  downloadContract(fileId);
}

// 或者使用模板文件ID（向后兼容）
async function composeContractByFileId(templateFileId, data) {
  const response = await fetch('http://your-domain:8080/api/compose/sdt', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      templateFileId: templateFileId,  // 使用模板文件ID
      values: data
    })
  });
  
  const result = await response.json();
  
  if (result.code === 200 || result.success) {
    return result.data.fileId;
  } else {
    throw new Error(result.message || '合成失败');
  }
}

// 下载合成的合同
async function downloadContract(fileId) {
  window.open(`http://your-domain:8080/api/onlyoffice/download/${fileId}`);
}

// 完整流程（使用模板编号）
async function generateContract() {
  try {
    // 1. 合成合同（使用模板编号，推荐方式）
    const templateCode = 'purchase_contract';  // 模板编号
    const fileId = await composeContract(templateCode, contractData);
    console.log('合同合成成功，文件ID:', fileId);
    
    // 2. 下载合同
    downloadContract(fileId);
    
  } catch (error) {
    console.error('合同生成失败:', error);
    alert('生成失败: ' + error.message);
  }
}

// 完整流程：合同 + 附件PDF + 骑缝章
async function generateContractWithAttachments() {
  try {
    const templateCode = 'purchase_contract';
    const contractData = {
      contractNo: 'GY-2025-001',
      partyA: '北京某某科技有限公司',
      partyB: '上海某某贸易有限公司',
      amount: '1,000,000.00'
    };
    
    // 需要合并的附件PDF
    const extraFiles = [
      'https://example.com/contracts/attachment1.pdf',
      'https://example.com/contracts/attachment2.pdf'
    ];
    
    // 1. 获取模板信息，识别印章字段
    const templateInfo = await getTemplateInfo(templateCode);
    const elements = JSON.parse(templateInfo.elementsJson).elements;
    const sealElements = elements.filter(el => el.type === 'seal');
    
    // 2. 构建普通章图片URL映射（key为tag）
    const stampImageUrls = {};
    sealElements.forEach(seal => {
      stampImageUrls[seal.tag] = {
        normal: `https://example.com/stamps/${seal.meta.code}.png`
      };
    });
    
    // 3. 骑缝章图片URL（独立参数，可选，不绑定任何字段）
    const ridingStampUrl = 'https://example.com/stamps/riding_seal.png';
    
    // 4. 合成合同（会自动合并附件PDF并盖骑缝章）
    const fileId = await composeContract(templateCode, contractData, extraFiles, stampImageUrls, ridingStampUrl);
    console.log('合同合成成功（已合并附件并盖章），文件ID:', fileId);
    
    // 2. 下载合同
    downloadContract(fileId);
    
  } catch (error) {
    console.error('合同生成失败:', error);
    alert('生成失败: ' + error.message);
  }
}
```

### 步骤4：预览合成结果

```html
<!-- 预览生成的合同 -->
<iframe 
  id="contractPreview"
  src="http://your-domain:3000/onlyoffice/editor?fileId=xxx&canEdit=false"
  width="100%"
  height="800px"
  frameborder="0"
></iframe>

<script>
  // 预览合同
  async function previewContract() {
  // 合成合同（使用模板编号）
  const templateCode = 'purchase_contract';  // 模板编号
  const fileId = await composeContract(templateCode, contractData);
    
    // 在iframe中显示
    document.getElementById('contractPreview').src = 
      `http://your-domain:3000/onlyoffice/editor?fileId=${fileId}&canEdit=false`;
  }
</script>
```

---

## 📚 完整 API 参考

### 1. 模板管理 API

> 📖 **详细说明**：模板管理的完整 API 文档请查看 [智能合同合成 API 文档](./智能合同合成-API版本-API文档.md)

## 合同合成支持的格式

### 支持的HTML样式

详见：[文档合成功能支持说明](./文档合成功能支持说明.md)

---

## 📞 技术支持

如需了解更多功能或有定制需求，请联系：

- 📧 官方网站：[https://zhaoxinms.com](https://zhaoxinms.com)
- 📦 产品价格：[https://zhaoxinms.com/price](https://zhaoxinms.com/price)

## 🔗 相关文档

- [智能合同合成 API 文档](./智能合同合成-API版本-API文档.md)
- [文档合成功能支持说明](./文档合成功能支持说明.md)
- [API 设计规范](./API设计文档.md)

