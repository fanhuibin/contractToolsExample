# 肇新合同工具集 - 授权码生成指南

## 📋 概述

本文档详细介绍如何生成和部署肇新合同工具集的授权License文件。

---

## 🎯 快速导航

- [授权模块说明](#授权模块说明)
- [生成方式对比](#生成方式对比)
- [方式一：命令行交互式生成（推荐）](#方式一命令行交互式生成推荐)
- [方式二：编程方式生成](#方式二编程方式生成)
- [部署授权文件](#部署授权文件)
- [验证授权](#验证授权)
- [故障排查](#故障排查)

---

## 授权模块说

### 可授权的6个功能模块

| 模块代码 | 模块名称 | 功能说明 |
|---------|---------|---------|
| `SMART_DOCUMENT_EXTRACTION` | 智能文档抽取 | AI驱动的合同条款提取和结构化 |
| `SMART_DOCUMENT_COMPARE` | 智能文档比对 | GPU OCR文档智能比对 |
| `SMART_CONTRACT_SYNTHESIS` | 智能合同合成 | 基于模板的合同智能生成 |
| `SMART_DOCUMENT_PARSE` | 智能文档解析 | OCR识别和文档解析 |
| `DOCUMENT_ONLINE_EDIT` | 文档在线编辑 | OnlyOffice在线编辑集成 |
| `DOCUMENT_FORMAT_CONVERT` | 文档格式转换 | PDF/Word/HTML等格式互转 |

### 4种预设授权场景

| 场景编号 | 场景名称 | 包含模块 | 适用客户 |
|---------|---------|---------|---------|
| **场景1** | 文档处理授权 | 智能文档解析<br>智能文档抽取 | 需要OCR识别和规则提取 |
| **场景2** | 文档比对授权 | 智能文档解析<br>智能文档比对 | 需要文档对比分析 |
| **场景3** | 合同制作授权 | 智能合同合成<br>文档在线编辑<br>文档格式转换 | 需要在线编辑和合成 |
| **场景4** | 全功能授权 | 所有6个模块 | 需要完整功能 |

---

## 生成方式对比

| 特性 | 命令行交互式 | 编程方式 |
|-----|------------|---------|
| **难度** | ⭐ 简单 | ⭐⭐⭐ 需要编程 |
| **适用场景** | 日常授权生成 | 批量生成/自动化 |
| **推荐人员** | 运维/商务人员 | 开发人员 |
| **交互方式** | 菜单选择 | 代码调用 |

---

## 方式一：命令行交互式生成（推荐）

### 步骤1：构建可执行JAR

```bash
cd contract-tools-auth-generator
mvn clean package
```

**生成文件**：`target/contract-tools-auth-generator-1.0.0-jar-with-dependencies.jar`

### 步骤2：运行生成器

```bash
java -jar target/contract-tools-auth-generator-1.0.0-jar-with-dependencies.jar
```

### 步骤3：交互式操作

#### 3.1 首次使用：生成密钥对

```
╔══════════════════════════════════════════════════════════════╗
║                                                              ║
║        肇新合同管理系统 - License快捷生成工具                ║
║                                                              ║
║        版本: 1.0.0                                           ║
║        作者: zhaoxinms.com                                   ║
║                                                              ║
╚══════════════════════════════════════════════════════════════╝

请选择操作：
1. 生成RSA密钥对
2. 场景1：授权【智能文档解析 + 智能文档抽取】
3. 场景2：授权【智能文档解析 + 智能文档比对】
4. 场景3：授权【智能合同合成 + 文档在线编辑】
5. 场景4：授权【全部功能】
0. 退出

请输入选项: 1
```

**填写密钥保存路径**：

```
请输入密钥保存目录 [默认: ./keys]: ./keys

正在生成密钥对...
✅ 密钥对生成成功！
   公钥路径: ./keys/public.key
   私钥路径: ./keys/private.key

⚠️  请妥善保管私钥文件，切勿泄露！
   公钥用于系统验证，可以公开
   私钥用于生成授权，必须保密
```

#### 3.2 生成授权License

**示例：为"测试公司"生成全功能授权**

```
请选择操作：
1. 生成RSA密钥对
2. 场景1：授权【智能文档解析 + 智能文档抽取】
3. 场景2：授权【智能文档解析 + 智能文档比对】
4. 场景3：授权【智能合同合成 + 文档在线编辑】
5. 场景4：授权【全部功能】
0. 退出

请输入选项: 5
```

**填写授权信息**：

```
╔════════════════ 场景4：全功能授权 ════════════════╗
授权模块：
  ✓ 智能文档抽取（规则提取）
  ✓ 智能文档比对（GPU比对）
  ✓ 智能合同合成（模板合成）
  ✓ 智能文档解析（OCR识别）
  ✓ 文档在线编辑（OnlyOffice）
  ✓ 文档格式转换（格式转换）
╚═════════════════════════════════════════════════════╝

请输入授权单位名称: 测试公司
请输入联系人姓名: 张三
请输入联系电话: 13800138000
请输入授权年限 [默认: 1年]: 1
是否绑定硬件 [y/N]: n
请输入私钥文件路径 [默认: ./keys/private.key]: 
请输入License输出路径 [默认: ./license.lic]: 
```

**生成成功**：

```
正在生成License文件...
✅ License生成成功！
╔═══════════════ License信息 ═══════════════╗
  授权码: FULL_1737192000000
  授权单位: 测试公司
  生效时间: 2025-01-18T10:00:00
  到期时间: 2026-01-18T10:00:00
  授权模块: 6 个
    - 智能文档抽取
    - 智能文档比对
    - 智能合同合成
    - 智能文档解析
    - 文档在线编辑
    - 文档格式转换
  输出路径: ./license.lic
╚═══════════════════════════════════════════╝

📋 请将生成的License文件部署到系统中
```

---

## 方式二：编程方式生成

### 2.1 添加依赖

```xml
<dependency>
    <groupId>com.zhaoxinms</groupId>
    <artifactId>contract-tools-auth-generator</artifactId>
    <version>1.0.0</version>
    <scope>test</scope> <!-- 仅在生成授权时使用 -->
</dependency>
```

### 2.2 生成密钥对

```java
import com.zhaoxinms.contract.tools.auth.generator.LicenseQuickGenerator;
import com.zhaoxinms.contract.tools.auth.generator.LicenseQuickGenerator.KeyPairResult;

public class KeyPairGeneratorExample {
    public static void main(String[] args) {
        LicenseQuickGenerator generator = new LicenseQuickGenerator();
        
        // 生成密钥对
        KeyPairResult result = generator.generateKeyPair("./keys");
        
        if (result.isSuccess()) {
            System.out.println("✅ 密钥对生成成功！");
            System.out.println("公钥路径: " + result.getPublicKeyPath());
            System.out.println("私钥路径: " + result.getPrivateKeyPath());
        } else {
            System.err.println("❌ 生成失败: " + result.getErrorMessage());
        }
    }
}
```

### 2.3 生成场景授权

#### 场景1：文档处理授权

```java
import com.zhaoxinms.contract.tools.auth.generator.LicenseQuickGenerator;
import com.zhaoxinms.contract.tools.auth.generator.LicenseQuickGenerator.GenerateResult;

public class Scenario1Example {
    public static void main(String[] args) {
        LicenseQuickGenerator generator = new LicenseQuickGenerator();
        
        GenerateResult result = generator.generateScenario1_ParseAndExtract(
            "测试公司",              // 授权单位名称
            "张三",                 // 联系人
            "13800138000",          // 联系电话
            1,                      // 授权年限（年）
            "./keys/private.key",   // 私钥路径
            "./license.lic"         // 输出路径
        );
        
        printResult(result);
    }
    
    private static void printResult(GenerateResult result) {
        if (result.isSuccess()) {
            System.out.println("✅ License生成成功！");
            System.out.println("授权码: " + result.getLicenseCode());
            System.out.println("授权单位: " + result.getCompanyName());
            System.out.println("生效时间: " + result.getStartDate());
            System.out.println("到期时间: " + result.getExpireDate());
            System.out.println("授权模块: " + result.getAuthorizedModules().size() + " 个");
            result.getAuthorizedModules().forEach(module -> 
                System.out.println("  - " + module.getName())
            );
            System.out.println("输出路径: " + result.getOutputPath());
        } else {
            System.err.println("❌ 生成失败: " + result.getErrorMessage());
        }
    }
}
```

#### 场景2：文档比对授权

```java
GenerateResult result = generator.generateScenario2_ParseAndCompare(
    "测试公司", "张三", "13800138000", 
    1, "./keys/private.key", "./license.lic"
);
```

#### 场景3：合同制作授权

```java
GenerateResult result = generator.generateScenario3_ComposeAndEdit(
    "测试公司", "张三", "13800138000", 
    1, "./keys/private.key", "./license.lic"
);
```

#### 场景4：全功能授权

```java
GenerateResult result = generator.generateScenario4_FullFeatures(
    "测试公司",              // 授权单位名称
    "张三",                 // 联系人
    "13800138000",          // 联系电话
    1,                      // 授权年限（年）
    false,                  // 是否绑定硬件
    "./keys/private.key",   // 私钥路径
    "./license.lic"         // 输出路径
);
```

### 2.4 硬件绑定授权

如果需要将授权绑定到特定硬件（防止授权文件被复制到其他机器）：

```java
GenerateResult result = generator.generateScenario4_FullFeatures(
    "测试公司", 
    "张三", 
    "13800138000", 
    1, 
    true,                    // ⚠️ 启用硬件绑定
    "./keys/private.key", 
    "./license.lic"
);
```

**⚠️ 注意**：启用硬件绑定后，授权文件只能在特定机器上使用。

---

## 部署授权文件

### 步骤1：准备文件

生成完成后，你将拥有以下文件：

```
keys/
  ├── public.key      # 公钥（需要部署到系统）
  └── private.key     # 私钥（妥善保管，不要部署到系统）

license.lic           # 授权文件（需要部署到系统）
```

### 步骤2：部署公钥

将公钥文件复制到系统的 `resources` 目录：

```bash
# 方式1：复制到 classpath（推荐）
cp keys/public.key contract-tools-sdk/src/main/resources/publicCerts.store

# 方式2：使用绝对路径（不推荐）
# 将公钥放在服务器的安全目录，如 /etc/zhaoxin/keys/public.key
```

### 步骤3：部署授权文件

```bash
# 方式1：复制到 classpath（推荐）
cp license.lic contract-tools-sdk/src/main/resources/license.lic

# 方式2：使用绝对路径（不推荐）
# 将授权文件放在服务器的配置目录，如 /etc/zhaoxin/license.lic
```

### 步骤4：配置 application.yml

```yaml
zhaoxin:
  auth:
    enabled: true  # 启用授权模块
    license:
      # 方式1：使用 classpath（推荐）
      file-path: classpath:license.lic
      
      # 方式2：使用绝对路径
      # file-path: /etc/zhaoxin/license.lic
    
    signature:
      # 方式1：使用 classpath（推荐）
      public-key-path: classpath:publicCerts.store
      
      # 方式2：使用绝对路径
      # public-key-path: /etc/zhaoxin/keys/public.key
```

### 步骤5：重启应用

```bash
cd contract-tools-sdk
mvn spring-boot:run
```

---

## 验证授权

### 方式1：通过前端页面（推荐）

1. 访问授权信息页面：http://localhost:3000/#/license

2. 检查显示内容：
   - ✅ 授权状态：正常/即将到期/已过期
   - ✅ 授权信息：授权单位、联系人、有效期
   - ✅ 硬件信息：MAC地址、CPU序列号等
   - ✅ 授权模块：已授权的功能模块列表

### 方式2：通过API接口

#### 获取授权信息

```bash
curl http://localhost:8080/api/auth/license-info
```

**成功响应**：

```json
{
  "success": true,
  "data": {
    "licenseCode": "FULL_1737192000000",
    "companyName": "测试公司",
    "contactPerson": "张三",
    "contactPhone": "13800138000",
    "startDate": "2025-01-18T10:00:00",
    "expireDate": "2026-01-18T10:00:00",
    "maxUsers": 100,
    "hardwareBound": false,
    "authorizedModules": [
      {
        "code": "SMART_DOCUMENT_EXTRACTION",
        "name": "智能文档抽取"
      },
      {
        "code": "SMART_DOCUMENT_COMPARE",
        "name": "智能文档比对"
      }
      // ... 其他模块
    ]
  }
}
```

#### 检查模块权限

```bash
curl -X POST http://localhost:8080/api/auth/check-modules \
  -H "Content-Type: application/json" \
  -d '["SMART_DOCUMENT_EXTRACTION", "SMART_DOCUMENT_COMPARE"]'
```

**成功响应**：

```json
{
  "success": true,
  "data": {
    "SMART_DOCUMENT_EXTRACTION": true,
    "SMART_DOCUMENT_COMPARE": true
  }
}
```

#### 获取硬件信息

```bash
curl http://localhost:8080/api/license/getServerInfos
```

**成功响应**：

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "osName": "Windows 10",
    "mainBoardSerial": "BFEBFBFF000906ED",
    "cpuSerial": "BFEBFBFF000906ED",
    "macAddress": ["00:15:5D:01:02:03"]
  }
}
```

---

## 故障排查

### 问题1：API返回404

**症状**：
```
GET http://localhost:8080/api/auth/license-info
=> 404 Not Found
```

**原因**：
1. 授权模块未启用
2. SDK项目未包含auth依赖
3. 后端服务未启动

**解决方案**：

```bash
# 1. 检查 application.yml 配置
grep "zhaoxin.auth.enabled" contract-tools-sdk/src/main/resources/application.yml
# 应该输出: enabled: true

# 2. 检查 pom.xml 依赖
grep -A 3 "contract-tools-auth" contract-tools-sdk/pom.xml
# 确认没有 <optional>true</optional>

# 3. 重新编译
cd contract-tools-sdk
mvn clean install -DskipTests

# 4. 重启服务
mvn spring-boot:run
```

### 问题2：授权信息为空

**症状**：
```json
{
  "success": false,
  "message": "未找到有效的授权信息"
}
```

**原因**：
1. 授权文件不存在
2. 授权文件路径配置错误
3. 授权文件损坏

**解决方案**：

```bash
# 1. 检查文件是否存在
ls -l contract-tools-sdk/src/main/resources/license.lic

# 2. 检查配置路径
grep "file-path" contract-tools-sdk/src/main/resources/application.yml

# 3. 重新生成授权文件
cd contract-tools-auth-generator
java -jar target/contract-tools-auth-generator-1.0.0-jar-with-dependencies.jar

# 4. 重新部署
cp license.lic ../contract-tools-sdk/src/main/resources/license.lic
```

### 问题3：签名验证失败

**症状**：
```json
{
  "success": false,
  "message": "授权文件签名验证失败"
}
```

**原因**：
1. 公钥与私钥不匹配
2. 授权文件被篡改
3. 公钥文件损坏

**解决方案**：

```bash
# 确保使用配套的公私钥
# 1. 使用生成授权时的私钥对应的公钥
cp keys/public.key contract-tools-sdk/src/main/resources/publicCerts.store

# 2. 或重新生成授权文件（使用正确的私钥）
```

### 问题4：授权已过期

**症状**：
```json
{
  "success": false,
  "message": "授权已过期"
}
```

**解决方案**：

```bash
# 生成新的授权文件（延长有效期）
cd contract-tools-auth-generator
java -jar target/contract-tools-auth-generator-1.0.0-jar-with-dependencies.jar

# 在填写授权年限时，输入更长的年限（如 5）
```

### 问题5：硬件不匹配

**症状**：
```json
{
  "success": false,
  "message": "硬件信息不匹配"
}
```

**原因**：
- 授权绑定的硬件与当前机器不匹配

**解决方案**：

```bash
# 方案1：为当前机器重新生成授权（绑定当前硬件）
# 方案2：生成不绑定硬件的授权
# 在生成授权时，选择 "是否绑定硬件 [y/N]: N"
```

---

## 🔒 安全建议

### 1. 私钥管理

- ✅ **妥善保管私钥**：私钥是生成授权的唯一凭证
- ✅ **离线存储**：将私钥存储在安全的离线环境
- ✅ **定期备份**：在安全的地方备份私钥
- ❌ **禁止泄露**：私钥绝对不能泄露给客户或外部人员
- ❌ **禁止部署**：私钥不应该部署到生产服务器

### 2. 公钥管理

- ✅ **可以公开**：公钥可以集成到系统代码中
- ✅ **可以分发**：公钥可以随系统一起分发给客户
- ✅ **定期验证**：确保公钥文件完整性

### 3. 授权文件管理

- ✅ **安全传输**：通过加密邮件、VPN等安全渠道发送授权文件
- ✅ **版本控制**：为每个客户保留授权文件的备份和记录
- ✅ **定期审核**：定期检查授权的有效期和使用情况

### 4. 生成环境安全

- ✅ **隔离环境**：在隔离的、安全的环境中生成License
- ✅ **清理临时文件**：生成后立即删除临时文件
- ❌ **禁止生产环境**：不要在生产服务器上运行生成器

---

## 📞 技术支持

如有问题，请联系：

- **企业网址**：https://www.zhaoxinms.com
- **技术支持**：develop@zhaoxinms.com
- **授权咨询**：联系商务团队

---

## 📄 附录

### A. 授权文件格式

授权文件（license.lic）采用以下格式：

```
<Base64编码的授权信息>.<Base64编码的RSA签名>
```

**示例**：
```
eyJsaWNlbnNlQ29kZSI6IkZVTEwxNzM3MTkyMDAwMDAwIiwiY29tcGFueU5hbWUi...
.
MEUCIQCxyz123ABC...
```

### B. 模块代码对照表

| 枚举值 | 代码 | 中文名称 |
|--------|------|---------|
| `SMART_DOCUMENT_EXTRACTION` | `smart_document_extraction` | 智能文档抽取 |
| `SMART_DOCUMENT_COMPARE` | `smart_document_compare` | 智能文档比对 |
| `SMART_CONTRACT_SYNTHESIS` | `smart_contract_synthesis` | 智能合同合成 |
| `SMART_DOCUMENT_PARSE` | `smart_document_parse` | 智能文档解析 |
| `DOCUMENT_ONLINE_EDIT` | `document_online_edit` | 文档在线编辑 |
| `DOCUMENT_FORMAT_CONVERT` | `document_format_convert` | 文档格式转换 |

### C. 快速命令参考

```bash
# 构建生成器
cd contract-tools-auth-generator
mvn clean package

# 运行生成器
java -jar target/contract-tools-auth-generator-1.0.0-jar-with-dependencies.jar

# 部署公钥
cp keys/public.key contract-tools-sdk/src/main/resources/publicCerts.store

# 部署授权文件
cp license.lic contract-tools-sdk/src/main/resources/license.lic

# 重启服务
cd contract-tools-sdk
mvn spring-boot:run

# 测试授权API
curl http://localhost:8080/api/auth/license-info
```

---

**文档版本**：v1.0.0  
**最后更新**：2025-01-18  
**作者**：肇新信息技术有限公司

