# 授权系统部署流程

## 一、一次性配置（生成密钥对并打包）

这个步骤只需要执行一次，生成的公钥会打包到JAR中，适用于所有客户部署。

### 1.1 生成RSA密钥对

```bash
cd contract-tools-auth-generator
mvn exec:java -Dexec.mainClass="com.zhaoxinms.contract.tools.auth.generator.LicenseQuickGeneratorCLI"
```

**操作步骤**：
1. 选择菜单选项 `5 - 生成RSA密钥对`
2. 密钥会生成到 `./keys/` 目录，包含3个文件：
   - `private.key` - 私钥（妥善保管，不要部署）
   - `public.key` - 公钥（需要打包到JAR）
   - `public.key.fingerprint` - 公钥指纹（需要打包到JAR）

**示例输出**：
```
开始生成RSA密钥对...
公钥已保存到: ./keys/public.key
公钥指纹已保存到: ./keys/public.key.fingerprint
公钥指纹值: a1b2c3d4e5f6...（64位十六进制字符串）
私钥已保存到: ./keys/private.key
```

### 1.2 部署公钥和指纹到SDK项目

```bash
# 在 contract-tools-auth-generator 目录下执行
Copy-Item .\keys\public.key ..\contract-tools-sdk\src\main\resources\publicCerts.store -Force
Copy-Item .\keys\public.key.fingerprint ..\contract-tools-sdk\src\main\resources\publicCerts.store.fingerprint -Force
```

**文件清单**：
```
contract-tools-sdk/src/main/resources/
├── publicCerts.store              # 公钥文件
├── publicCerts.store.fingerprint  # 公钥指纹文件
└── application.yml                # 配置文件
```

### 1.3 打包SDK项目

```bash
cd contract-tools-sdk
mvn clean package -DskipTests
```

**生成的JAR包**：
- `target/contract-tools-sdk-1.0.0.jar`
- 包含公钥和指纹，适用于所有客户部署
- **不包含授权文件**（每个客户的授权文件不同）

---

## 二、每次为客户生成授权（重复执行）

每次为新客户或现有客户续期时执行以下步骤。

### 2.1 生成授权文件

```bash
cd contract-tools-auth-generator
mvn exec:java -Dexec.mainClass="com.zhaoxinms.contract.tools.auth.generator.LicenseQuickGeneratorCLI"
```

**操作步骤**：
1. 选择授权场景（例如 `4 - 全功能授权`）
2. 填写客户信息：
   - 授权单位：客户公司名称
   - 联系人：客户联系人
   - 联系电话：客户电话
3. 选择授权类型：
   - `1 - 按天授权`
   - `2 - 按年授权`
   - `3 - 永久授权`
4. 是否绑定硬件：
   - 不绑定：输入 `N`
   - 绑定硬件：输入 `Y`，然后选择导入机器信息或手动输入
5. 私钥路径：`./keys/private.key`（默认）

**生成结果**：
```
./licenses/
└── 客户公司_20251020_143022/
    ├── license.lic        # 授权文件（需要部署）
    └── license-info.txt   # 授权详情（供记录）
```

### 2.2 部署授权文件到客户环境

**方式1：开发/测试环境**
```bash
Copy-Item ".\licenses\客户公司_20251020_143022\license.lic" ..\contract-tools-sdk\src\main\resources\license.lic -Force
cd ..\contract-tools-sdk
mvn spring-boot:run
```

**方式2：生产环境（推荐）**
```bash
# 将 license.lic 放到以下位置之一：
# 1. JAR包同级目录
cp license.lic /path/to/app/license.lic

# 2. JAR包同级的config目录
cp license.lic /path/to/app/config/license.lic

# 3. 启动应用
java -jar contract-tools-sdk-1.0.0.jar
```

---

## 三、文件加载优先级

### 3.1 公钥文件（固定，不可变）
- ✅ **只能从classpath加载**（JAR包内部）
- ✅ **不支持外部文件覆盖**（安全保护）
- ✅ **指纹验证**（防止篡改）

配置路径：
```yaml
zhaoxin:
  auth:
    signature:
      public-key-path: classpath:publicCerts.store
```

### 3.2 授权文件（每个客户不同）
加载优先级（按顺序）：
1. JAR包同级目录：`./license.lic`
2. config目录：`./config/license.lic`
3. classpath：`classpath:license.lic`（开发环境）

配置路径：
```yaml
zhaoxin:
  auth:
    license:
      file-path: classpath:license.lic
```

---

## 四、安全机制

### 4.1 公钥保护
- ✅ **强制classpath加载**：公钥只能从JAR包内部加载
- ✅ **SHA-256指纹验证**：运行时验证公钥完整性
- ✅ **无法外部覆盖**：即使反编译JAR也无法替换公钥

### 4.2 授权文件保护
- ✅ **RSA 2048位数字签名**：无法伪造
- ✅ **时间验证**：过期自动失效
- ✅ **硬件绑定**（可选）：绑定特定硬件

### 4.3 私钥安全
- ❌ **绝对不要部署私钥到生产环境**
- ✅ 只用于生成授权文件时签名
- ✅ 妥善保管在安全位置

---

## 五、启动时的授权验证

应用启动时会自动验证并显示授权信息：

**成功示例**：
```
========================================
      系统授权信息验证
========================================
✅ 授权验证通过
----------------------------------------
  授权单位: 测试公司
  授权码: FULL_1760933482525
  联系人: 技术部
  联系电话: 13800138000
  生效时间: 2025-10-20 12:11:22
  到期时间: 永久授权
  硬件绑定: 已启用
----------------------------------------
  授权模块 (6个):
    ✓ 智能文档抽取
    ✓ 智能文档比对
    ✓ 智能合同合成
    ✓ 智能文档解析
    ✓ 文档在线编辑
    ✓ 文档格式转换
========================================
```

**失败示例**：
```
========================================
      系统授权信息验证
========================================
❌ 授权验证失败
----------------------------------------
  失败原因: License文件不存在: classpath:license.lic
========================================

请检查授权文件配置：
  1. 开发环境：将授权文件放到 src/main/resources/ 目录
  2. 生产环境：将授权文件放到以下位置之一：
     - JAR包同级目录: ./license.lic
     - config目录: ./config/license.lic
========================================
```

---

## 六、常见问题

### Q1: 如何更新公钥？
**不建议更新**。如果必须更新：
1. 重新生成密钥对
2. 重新打包SDK（所有已部署的系统需要更新JAR包）
3. 为所有客户重新生成授权文件

### Q2: 如何为客户续期？
只需要重新生成新的授权文件，不需要更新JAR包：
1. 使用相同的私钥生成新授权
2. 替换客户环境的 `license.lic` 文件
3. 重启应用

### Q3: 可以给不同客户使用不同的公钥吗？
**不建议**。推荐使用同一个公钥，通过授权文件区分客户：
- 优点：JAR包统一，便于维护
- 缺点：私钥泄露影响所有客户

### Q4: 公钥指纹验证失败怎么办？
说明公钥文件被篡改。检查：
1. 确认 `publicCerts.store` 和 `publicCerts.store.fingerprint` 是配对的
2. 重新从备份恢复或重新部署

---

## 七、文件清单总结

### 开发人员保管（不部署）
```
contract-tools-auth-generator/keys/
├── private.key                    # 私钥（绝对保密）
├── public.key                     # 公钥（复制到SDK）
└── public.key.fingerprint         # 指纹（复制到SDK）
```

### 打包到JAR（一次性）
```
contract-tools-sdk/src/main/resources/
├── publicCerts.store              # 公钥
├── publicCerts.store.fingerprint  # 公钥指纹
└── application.yml                # 配置
```

### 每个客户独立（重复生成）
```
contract-tools-auth-generator/licenses/客户名_日期/
├── license.lic                    # 授权文件
└── license-info.txt               # 授权详情
```

---

**部署完成后，您的系统就可以安全地运行了！每次只需要为新客户生成授权文件即可。**

