# 规则3：相似度验证算法

## 概述

规则3是`DiffBlockValidationUtil`中新增的文本相似度验证规则，用于验证小于200字符的文本差异是否为模型幻觉。

## 工作原理

### 基本逻辑
1. **长度检查**：只适用于小于200字符的目标文本
2. **相似度计算**：使用编辑距离相似度算法
3. **对比验证**：比较原始文本和去除差异文本后的相似度
4. **验证判断**：如果去除差异文本后相似度提高，则认为验证通过

### 详细步骤

```
1. 检查 targetText.length() < 200
2. 计算 similarity1 = LevenshteinSimilarity(原始文本, bbox文本)
3. 生成 textWithoutDiff = 原始文本 - 差异文本
4. 计算 similarity2 = LevenshteinSimilarity(textWithoutDiff, bbox文本)
5. 判断：如果 similarity2 > similarity1，则验证通过
```

## 使用场景

### 适用情况
- 目标文本长度 < 200字符
- 差异文本可能是OCR识别错误或模型幻觉
- bbox文本与原始文本基本相似，但有细微差异

### 典型示例

#### 示例1：下划线误识别
```
原始文本: "1.4合同期限为___年，从2021年0月01日到2021年0月31日止。"
bbox文本:  "1.4合同期限为年，从2021年0月01日到2021年0月31日止。"
差异文本: "___"

分析：
- 原始相似度: 0.9565 (很高但不完美)
- 去除"___"后: "1.4合同期限为年，从2021年0月01日到2021年0月31日止。"
- 去除后相似度: 1.0000 (完全匹配)
- 相似度提升: +0.0435
- 结果: ✓ 验证通过
```

#### 示例2：OCR错误字符
```
原始文本: "合同期限为_年，从201年0月01日到小201年0月31日止"
bbox文本:  "合同期限为年，从201年0月01日到201年0月31日止"
差异文本: "_" 或 "小"

分析：
- 通过去除误识别的字符，文本与bbox更加匹配
- 相似度有明显提升
- 结果: ✓ 验证通过
```

#### 示例3：负面案例
```
原始文本: "这是一个完全不同的文本"
bbox文本:  "这是另外一个文本内容"
差异文本: "完全不同"

分析：
- 即使去除差异文本，两个文本仍然很不相似
- 相似度没有明显提升或甚至下降
- 结果: ✗ 验证失败
```

## 技术实现

### 相似度算法选择
- **主算法**：编辑距离相似度（Levenshtein Similarity）
- **原因**：对字符级别的变化敏感，适合检测OCR错误

### 算法特点
- **字符级分割**：支持中文文本的字符级别比较
- **数字序列识别**：特别处理数字序列
- **标点符号处理**：识别标点符号模式
- **空格标准化**：支持空格容错模式

### 性能考虑
- **文本长度限制**：200字符，确保算法效率
- **计算复杂度**：O(m*n)，m和n为文本长度
- **内存占用**：适中，适合实时处理

## 集成方式

### 在验证流程中的位置
```
规则1：尾部5字符匹配
↓ (如果失败)
规则2：双bbox尾头匹配（2字符）
↓ (如果失败)
规则3：相似度验证 ← 新增
↓ (如果失败)
验证失败
```

### 调试日志示例
```
[DEBUG] 相似度验证: 开始验证，文本长度: 56
[DEBUG]   原始目标文本: "1.4合同期限为___年，从2021年0月01日到2021年0月31日止。"
[DEBUG]   bbox文本: "1.4合同期限为年，从2021年0月01日到2021年0月31日止。"
[DEBUG]   差异文本: "___"
[DEBUG] 相似度验证结果:
[DEBUG]   原始文本相似度: 0.9565
[DEBUG]   去掉差异文本: "1.4合同期限为年，从2021年0月01日到2021年0月31日止。"
[DEBUG]   去除差异后相似度: 1.0000
[DEBUG]   相似度提升: 0.0435
[INFO]  ✓ 新增 验证通过 (精确相似度验证): 移除第1个"___"后相似度从0.9565提升到1.0000(+0.0435)
```

## 配置参数

### 可调整参数
- **文本长度阈值**：200字符（可根据需要调整）
- **相似度算法**：当前使用编辑距离，可扩展为其他算法
- **最小提升阈值**：当前为任何提升，可设置最小提升值

### 未来扩展
- 支持多种相似度算法组合
- 自适应阈值调整
- 基于文本类型的特化算法
