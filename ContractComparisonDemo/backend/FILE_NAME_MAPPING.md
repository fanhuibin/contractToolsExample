# 文件名映射机制说明

## 问题背景

由于中文文件名可能导致URL编码问题，Demo后端将上传的文件保存为UUID命名，但需要在前端显示原始文件名。

## 解决方案

### 工作流程

1. **文件上传阶段**
   - 前端上传文件（如：`电脑及办公设备采购合同（无乙方）.doc`）
   - Demo后端保存为UUID文件（如：`42dc2fb0-c22f-4014-900f-e5972ad762ed.doc`）
   - 同时返回原始文件名

2. **提交比对任务**
   - 前端从File对象获取原始文件名
   - 提交到Demo后端：UUID文件URL + 原始文件名
   - Demo后端转发UUID文件URL到SDK（**不传文件名**）
   - Demo后端保存映射：`taskId` → `{oldFileName, newFileName}`

3. **读取任务列表**
   - SDK返回任务列表（文件名为空或UUID）
   - Demo后端从本地映射中查找原始文件名
   - 替换SDK返回的文件名为原始文件名
   - 返回给前端

### 数据流图

```
前端                     Demo后端                    SDK后端
 │                          │                          │
 │──上传文件(原始名)────────→│                          │
 │                          │──保存为UUID文件           │
 │←─返回(UUID URL+原始名)───│                          │
 │                          │                          │
 │──提交任务────────────────→│                          │
 │  (UUID URL+原始名)        │──提交任务(UUID URL)─────→│
 │                          │  (不传文件名)            │
 │                          │←─返回taskId─────────────│
 │                          │──保存映射:                │
 │                          │  taskId→原始文件名        │
 │                          │                          │
 │──获取任务列表────────────→│                          │
 │                          │──获取任务列表───────────→│
 │                          │←─返回(文件名为空)────────│
 │                          │──从映射获取原始文件名      │
 │←─返回(替换为原始名)──────│                          │
```

### 核心组件

#### 1. TaskFileMapping.java
任务文件名映射实体类
```java
{
  taskId: "task-uuid-12345",
  oldFileName: "电脑及办公设备采购合同（无乙方）.doc",
  newFileName: "电脑及办公设备采购合同（有乙方）.doc",
  createTime: 1735564800000
}
```

#### 2. TaskFileMappingService.java
映射管理服务
- 保存映射到 `task-mappings.json`
- 提供查询、删除功能
- 使用内存缓存提高性能

#### 3. CompareProxyController.java
修改点：
- `submitCompare`: 提交后保存映射（不传文件名给SDK）
- `getTaskStatus`: 替换文件名
- `getAllTasks`: 批量替换文件名
- `deleteTask`: 同时删除映射

#### 4. 前端 Compare.vue
修改点：
- 直接从 `File.name` 获取原始文件名
- 不再依赖后端返回的文件名

### 数据存储

**文件**: `task-mappings.json`（项目根目录）

```json
[
  {
    "taskId": "task-uuid-12345",
    "oldFileName": "电脑及办公设备采购合同（无乙方）.doc",
    "newFileName": "电脑及办公设备采购合同（有乙方）.doc",
    "createTime": 1735564800000
  }
]
```

### 优势

1. ✅ **避免中文问题**: 文件以UUID存储，URL安全
2. ✅ **用户友好**: 前端始终显示原始文件名
3. ✅ **解耦设计**: Demo后端独立管理文件名，不依赖SDK
4. ✅ **数据持久化**: 重启服务后映射仍然有效
5. ✅ **自动清理**: 删除任务时同时清理映射

### 注意事项

- `task-mappings.json` 文件会自动创建
- 建议定期备份该文件
- 如果映射丢失，任务列表将显示空文件名

