# MinerU 1000x1000 归一化测试

## 测试数据

### 输入
```json
{
  "type": "text",
  "text": "线材质量要求符合国家标准 GB/T70L-1997，螺纹钢材质符合国家标准 GB1499-1998。",
  "bbox": [144, 789, 848, 829],
  "page_idx": 1
}
```

### 图片尺寸
```
1322 x 1870 像素
```

## 预期计算

### 缩放比例
```
scaleX = 1322 / 1000 = 1.322
scaleY = 1870 / 1000 = 1.870
```

### 转换结果
```
x1 = 144 * 1.322 = 190.368 ≈ 190
y1 = 789 * 1.870 = 1475.43 ≈ 1475
x2 = 848 * 1.322 = 1120.96 ≈ 1121  ← 关键！
y2 = 829 * 1.870 = 1550.23 ≈ 1550
```

**预期结果**: `[190, 1475, 1121, 1550]`

## 当前错误结果

```
[190, 1475, 787, 1550]  ← x2 错误！
```

### 错误分析

```
787 是怎么来的？
787 / 1.322 = 595.31

595 = A4 纸的 PDF 宽度！
```

**结论**: 旧代码可能在用 PDF 宽度而不是 1000 来计算。

## 测试步骤

### 1. 重启服务
```bash
# 停止当前服务
# 启动新服务（使用新编译的代码）
```

### 2. 运行测试

上传包含该文本的 PDF，查看日志输出：

### 3. 检查日志

**应该看到**：
```
🔧 坐标转换 - PDF尺寸: 595.0x842.0, 图片尺寸: 1322x1870, MinerU归一化: 1000x1000, 缩放比例: scaleX=1.322, scaleY=1.870
📍 MinerU原始bbox: [144.0, 789.0, 848.0, 829.0]
✅ 转换后图片bbox: [190, 1475, 1121, 1550]
                                    ^^^^
                                    这里应该是 1121，不是 787！
```

### 4. 验证前端标注

在前端查看该文本的标注框：
- 应该横跨大部分页面宽度（x2=1121 ≈ 85% 宽度）
- 如果 x2=787，只会标注到页面中间（≈ 60% 宽度）

## 预期改进

### 性能提升

新代码还包含**并行渲染优化**：

```
旧: 8页 × 2秒 = 16秒（串行）
新: 8页 ÷ 4核 = 2-4秒（并行）

提速 75%！
```

**日志输出示例**：
```
2025-10-07 19:20:00 [INFO] 开始并行生成8个页面图片，DPI: 200
2025-10-07 19:20:03 [INFO] 页面图片生成完成，共8页，耗时3245ms（平均每页405ms）
                                                          ^^^^^^^^
                                                          应该从 16000ms 降低到 3000ms 左右
```

## 故障排除

### 如果还是 787

1. **确认代码更新**：
   ```bash
   # 检查编译时间
   ls -l contract-tools-core/target/classes/com/zhaoxinms/contract/tools/comparePRO/util/MinerUCoordinateConverter.class
   ```

2. **检查日志中的归一化值**：
   ```bash
   grep "MinerU归一化" logs/*.log
   ```
   
   应该看到: `MinerU归一化: 1000x1000`

3. **清理并重新编译**：
   ```bash
   mvn clean compile -pl contract-tools-core -DskipTests
   ```

4. **完全重启**：
   - 停止所有 Java 进程
   - 清除缓存
   - 重新启动

---

**关键点**: 
- ✅ x2 应该是 **1121**（848 * 1.322）
- ❌ 不应该是 **787**（这是旧代码的 bug）
- ✅ MinerU 使用 **1000x1000** 归一化
- ✅ X 和 Y **独立缩放**

