# ğŸ” MinerUåæ ‡è¶…å‡ºè¾¹ç•Œé—®é¢˜åˆ†æ

## ğŸ“‹ é—®é¢˜ç°è±¡

```
åæ ‡è¶…å‡ºè¾¹ç•Œï¼Œè¿›è¡Œä¿®æ­£: [320, 1279, 1892, 1579] -> [320, 1279, 1322, 1579]
```

- **å›¾ç‰‡å°ºå¯¸**: 1322 x 1870ï¼ˆDPI 160æ¸²æŸ“ï¼‰
- **MinerUè¿”å›çš„x2**: 1892
- **è¶…å‡ºå›¾ç‰‡å®½åº¦**: 1892 > 1322

## ğŸ” æ ¹æœ¬åŸå› 

### MinerUå¯èƒ½è¿”å›è¶…å‡ºPDFå®é™…å°ºå¯¸çš„åæ ‡

è¿™ç§æƒ…å†µå¯èƒ½æ˜¯å› ä¸ºï¼š

1. **è¯†åˆ«ç®—æ³•çš„è¾¹ç•Œæ‰©å±•**
   - MinerUåœ¨è¯†åˆ«æ–‡æœ¬å—æ—¶ï¼Œå¯èƒ½ä¼šç¨å¾®æ‰©å±•è¾¹ç•Œä»¥ç¡®ä¿å®Œæ•´æ•è·å†…å®¹
   - å°¤å…¶æ˜¯å¯¹äºæ¥è¿‘è¾¹ç¼˜çš„æ–‡æœ¬ï¼Œç®—æ³•å¯èƒ½ä¼šå‘å¤–æ‰©å±•å‡ ä¸ªåƒç´ 

2. **PDFè£åˆ‡æ¡† vs åª’ä½“æ¡†**
   - PDFæœ‰å¤šç§å°ºå¯¸æ¡†ï¼ˆMediaBox, CropBox, TrimBoxç­‰ï¼‰
   - MinerUå¯èƒ½ä½¿ç”¨çš„æ˜¯ä¸åŒçš„æ¡†ä½œä¸ºå‚è€ƒ
   - PDFBoxé»˜è®¤ä½¿ç”¨MediaBox

3. **æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜**
   - åæ ‡è½¬æ¢æ¶‰åŠå¤šæ¬¡æµ®ç‚¹æ•°è¿ç®—
   - å¯èƒ½å­˜åœ¨ç´¯ç§¯è¯¯å·®

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. ä¸¤çº§ä¿®æ­£ç­–ç•¥

**ç¬¬ä¸€çº§ï¼šä¿®æ­£MinerUåŸå§‹åæ ‡**
```java
// åœ¨è½¬æ¢å‰ï¼Œå…ˆç¡®ä¿MinerUåæ ‡åœ¨PDFèŒƒå›´å†…
if (mineruBbox[2] > pdfWidth || mineruBbox[3] > pdfHeight) {
    log.warn("âš ï¸  MinerUè¿”å›çš„åæ ‡è¶…å‡ºPDFå°ºå¯¸ï¼");
    log.warn("   PDFå°ºå¯¸: {}x{}, MinerU bbox: [{}, {}, {}, {}]", 
        pdfWidth, pdfHeight, mineruBbox[0], mineruBbox[1], mineruBbox[2], mineruBbox[3]);
    
    // ä¿®æ­£åˆ°PDFèŒƒå›´å†…
    mineruBbox[2] = Math.min(mineruBbox[2], pdfWidth);
    mineruBbox[3] = Math.min(mineruBbox[3], pdfHeight);
}
```

**ç¬¬äºŒçº§ï¼šä¿®æ­£è½¬æ¢åå›¾ç‰‡åæ ‡**
```java
// è½¬æ¢åå†æ¬¡éªŒè¯ï¼ˆé˜²æ­¢æµ®ç‚¹æ•°èˆå…¥è¯¯å·®ï¼‰
if (!MinerUCoordinateConverter.isValidBbox(imageBbox, imageWidth, imageHeight)) {
    imageBbox = MinerUCoordinateConverter.clampBbox(imageBbox, imageWidth, imageHeight);
}
```

### 2. åæ ‡è½¬æ¢æµç¨‹

```
MinerUåŸå§‹åæ ‡ï¼ˆPDFåæ ‡ç³»ï¼‰
    â†“
æ£€æŸ¥å¹¶ä¿®æ­£åˆ°PDFå°ºå¯¸èŒƒå›´å†…
    â†“
è½¬æ¢åˆ°å›¾ç‰‡åæ ‡ç³»ï¼ˆç¼©æ”¾ï¼‰
    â†“
æ£€æŸ¥å¹¶ä¿®æ­£åˆ°å›¾ç‰‡å°ºå¯¸èŒƒå›´å†…
    â†“
æœ€ç»ˆåæ ‡
```

## ğŸ“Š æ•°æ®ç¤ºä¾‹

### åæ ‡è¶…å‡ºæƒ…å†µ

| MinerUåæ ‡ | PDFå°ºå¯¸ | è¶…å‡ºé‡ | ä¿®æ­£å | å›¾ç‰‡å°ºå¯¸ | æœ€ç»ˆå›¾ç‰‡åæ ‡ |
|-----------|---------|--------|--------|---------|-------------|
| [320, 1279, **1892**, 1579] | 595 x 842 | 1892 - 595 = **1297** | [320, 1279, 595, 1579] | 1322 x 1870 | [320, 1279, 1322, 1579] |

### æ­£å¸¸æƒ…å†µ

| MinerUåæ ‡ | PDFå°ºå¯¸ | è¶…å‡ºé‡ | å›¾ç‰‡å°ºå¯¸ | æœ€ç»ˆå›¾ç‰‡åæ ‡ |
|-----------|---------|--------|---------|-------------|
| [100, 200, 500, 400] | 595 x 842 | 0 | 1322 x 1870 | [222, 444, 1110, 888] |

## ğŸ”§ ä»£ç ä½ç½®

**æ–‡ä»¶**: `MinerUOCRService.java`

**æ–¹æ³•**: `convertMinerUToCharBox()`

**å…³é”®ä»£ç æ®µ**:
```java
// é¦–å…ˆæ£€æŸ¥MinerUçš„åŸå§‹åæ ‡æ˜¯å¦è¶…å‡ºPDFå°ºå¯¸
if (mineruBbox[2] > pdfWidth || mineruBbox[3] > pdfHeight) {
    // ä¿®æ­£MinerUçš„åŸå§‹åæ ‡åˆ°PDFå°ºå¯¸èŒƒå›´å†…
    mineruBbox[0] = Math.max(0, Math.min(mineruBbox[0], pdfWidth));
    mineruBbox[1] = Math.max(0, Math.min(mineruBbox[1], pdfHeight));
    mineruBbox[2] = Math.max(mineruBbox[0], Math.min(mineruBbox[2], pdfWidth));
    mineruBbox[3] = Math.max(mineruBbox[1], Math.min(mineruBbox[3], pdfHeight));
}
```

## ğŸ“ˆ å½±å“è¯„ä¼°

### ä¿®æ­£å‰
- âŒ åæ ‡è¶…å‡ºå›¾ç‰‡èŒƒå›´
- âŒ å¯èƒ½å¯¼è‡´å‰ç«¯æ˜¾ç¤ºå¼‚å¸¸
- âŒ å¯èƒ½å¯¼è‡´bboxç»˜åˆ¶é”™è¯¯

### ä¿®æ­£å
- âœ… æ‰€æœ‰åæ ‡éƒ½åœ¨æœ‰æ•ˆèŒƒå›´å†…
- âœ… å‰ç«¯å¯ä»¥æ­£ç¡®æ˜¾ç¤ºé«˜äº®æ¡†
- âœ… æ–‡æœ¬å®šä½å‡†ç¡®

### ç²¾åº¦æŸå¤±
- âš ï¸  è¶…å‡ºè¾¹ç•Œçš„éƒ¨åˆ†ä¼šè¢«è£å‰ª
- âš ï¸  å¯¹äºæ¥è¿‘è¾¹ç¼˜çš„æ–‡æœ¬ï¼Œbboxå¯èƒ½ç•¥å°äºå®é™…å¤§å°
- âœ… ä½†ä¸å½±å“æ–‡æœ¬å†…å®¹è¯†åˆ«
- âœ… è§†è§‰æ•ˆæœå¯æ¥å—

## ğŸ¯ åç»­ä¼˜åŒ–å»ºè®®

### 1. è°ƒæŸ¥PDFåæ ‡ç³»å·®å¼‚
```java
// æ‰“å°PDFçš„å„ç§å°ºå¯¸æ¡†ä»¥ä¾›åˆ†æ
PDPage page = document.getPage(pageIndex);
log.info("MediaBox: {}", page.getMediaBox());
log.info("CropBox: {}", page.getCropBox());
log.info("TrimBox: {}", page.getTrimBox());
```

### 2. å‘MinerUæŠ¥å‘Šé—®é¢˜
- æ”¶é›†è¶…å‡ºè¾¹ç•Œçš„æ¡ˆä¾‹
- æ£€æŸ¥æ˜¯å¦ä¸ºMinerUçš„bug
- æäº¤issueåˆ°MinerUä»“åº“

### 3. ç»Ÿè®¡è¶…å‡ºæ¯”ä¾‹
```java
// è®°å½•è¶…å‡ºè¾¹ç•Œçš„é¢‘ç‡å’Œå¹…åº¦
int totalBboxes = 0;
int outOfBoundsBboxes = 0;
double maxExceedRatio = 0;
```

## âœ… éªŒè¯æ–¹æ³•

### 1. æ£€æŸ¥æ—¥å¿—
```
âš ï¸  MinerUè¿”å›çš„åæ ‡è¶…å‡ºPDFå°ºå¯¸ï¼
   PDFå°ºå¯¸: 595.0x842.0, MinerU bbox: [320.0, 1279.0, 1892.0, 1579.0]
   ä¿®æ­£åbbox: [320.0, 1279.0, 595.0, 1579.0]
```

### 2. æ£€æŸ¥ä¿å­˜çš„JSON
æŸ¥çœ‹ `uploads/compare-pro/tasks/{taskId}/ocr/mineru_raw_old.json`ï¼š
```json
{
  "bbox": [320, 1279, 1892, 1579],  // åŸå§‹åæ ‡
  "text": "..."
}
```

æŸ¥çœ‹ `mineru_processed_old.json`ï¼š
```json
{
  "bbox": [320, 1279, 1322, 1579],  // ä¿®æ­£ååæ ‡
  "text": "..."
}
```

### 3. å‰ç«¯éªŒè¯
- æ‰€æœ‰é«˜äº®æ¡†éƒ½åº”è¯¥åœ¨å›¾ç‰‡èŒƒå›´å†…
- æ²¡æœ‰éƒ¨åˆ†æ¡†è¢«è£å‰ªçš„æƒ…å†µ
- æ–‡æœ¬å®šä½å‡†ç¡®

---

**ç»“è®º**: è¿™æ˜¯MinerUçš„ä¸€ä¸ªå·²çŸ¥è¡Œä¸ºï¼Œé€šè¿‡ä¸¤çº§ä¿®æ­£ç­–ç•¥å¯ä»¥å®‰å…¨å¤„ç†ã€‚

**æœ€åæ›´æ–°**: 2025-10-07

