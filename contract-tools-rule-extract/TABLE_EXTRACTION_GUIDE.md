# 表格提取功能使用指南

## 概述

表格提取器 `TableCellMatcher` 已升级，现在支持基于 **MinerU** 返回的 HTML 格式表格进行智能提取。

## 主要特性

### ✅ 自动解析 HTML 表格
- 自动识别文档中的所有 HTML `<table>` 标签
- 支持 `<th>` 和 `<td>` 标签的解析
- 自动清理 HTML 标签和实体编码

### ✅ 智能表头匹配
- 通过表头关键词特征识别目标表格
- 支持多关键词匹配（使用 `|` 分隔）
- 不再需要表格标识和分隔符配置

### ✅ 两种提取模式
1. **单元格模式** (`cell`): 提取表格中的单个字段值
2. **整表模式** (`table`): 提取完整表格数据

## 使用示例

### 模式 1: 提取单个单元格

适用场景：需要提取表格中某一行某一列的具体数值，如"合同金额"、"交货日期"等。

#### 配置示例 1 - 按列名提取

```json
{
  "extractMode": "cell",
  "headerPattern": "商品名称|数量|单价",
  "targetColumn": "商品名称",
  "occurrence": 1
}
```

**说明：**
- `extractMode`: 设置为 `cell` 表示单元格提取模式
- `headerPattern`: 表头特征，包含这些关键词的表格会被识别为目标表格
- `targetColumn`: 要提取的目标列名
- `occurrence`: 提取第几个匹配项（默认为 1）

#### 配置示例 2 - 按行标记提取

```json
{
  "extractMode": "cell",
  "headerPattern": "商品名称|数量|金额",
  "targetColumn": "金额",
  "rowMarker": "合计"
}
```

**说明：**
- `rowMarker`: 行标识关键词，会查找包含该关键词的行

#### 配置示例 3 - 按索引提取

```json
{
  "extractMode": "cell",
  "headerPattern": "序号|名称|金额",
  "columnIndex": 3,
  "rowIndex": 2
}
```

**说明：**
- `columnIndex`: 列索引（从 1 开始）
- `rowIndex`: 行索引（从 1 开始）

#### 配置示例 4 - 提取所有匹配项

```json
{
  "extractMode": "cell",
  "headerPattern": "商品名称|数量",
  "targetColumn": "商品名称",
  "returnAll": true
}
```

**说明：**
- `returnAll`: 设置为 `true` 时，返回该列所有非空值

**返回结果示例：**

```json
{
  "success": true,
  "value": "笔记本电脑",
  "allMatches": ["笔记本电脑", "鼠标", "键盘"],
  "confidence": 90,
  "debugInfo": [
    "提取模式: cell",
    "表头特征: 商品名称|数量",
    "找到 1 个表格",
    "找到目标表格，表头: 序号, 商品名称, 数量, 单价",
    "目标列索引: 1 (商品名称)",
    "提取单元格成功: 笔记本电脑",
    "所有匹配项数量: 3",
    "表格预览:\n| 序号 | 商品名称 | 数量 | 单价 |\n| --- | --- | --- | --- |\n| 1 | 笔记本电脑 | 2 | 5000 |\n| 2 | 鼠标 | 10 | 50 |\n| 3 | 键盘 | 5 | 200 |"
  ]
}
```

---

### 模式 2: 提取整个表格

适用场景：需要提取完整的表格数据，用于后续处理、展示或存储。

#### 配置示例 1 - JSON 格式（默认）

```json
{
  "extractMode": "table",
  "headerPattern": "商品名称|数量|单价",
  "format": "json"
}
```

**返回结果示例：**

```json
{
  "success": true,
  "value": "[\n  {\"序号\":\"1\",\"商品名称\":\"笔记本电脑\",\"数量\":\"2\",\"单价\":\"5000\"},\n  {\"序号\":\"2\",\"商品名称\":\"鼠标\",\"数量\":\"10\",\"单价\":\"50\"},\n  {\"序号\":\"3\",\"商品名称\":\"键盘\",\"数量\":\"5\",\"单价\":\"200\"}\n]",
  "tableData": [
    {"序号":"1", "商品名称":"笔记本电脑", "数量":"2", "单价":"5000"},
    {"序号":"2", "商品名称":"鼠标", "数量":"10", "单价":"50"},
    {"序号":"3", "商品名称":"键盘", "数量":"5", "单价":"200"}
  ],
  "confidence": 95,
  "debugInfo": [
    "提取模式: table",
    "表头特征: 商品名称|数量|单价",
    "找到 1 个表格",
    "找到目标表格，表头: 序号, 商品名称, 数量, 单价",
    "提取整表成功，格式: json",
    "行数: 3, 列数: 4",
    "表格预览:\n| 序号 | 商品名称 | 数量 | 单价 |\n| --- | --- | --- | --- |\n| 1 | 笔记本电脑 | 2 | 5000 |\n| 2 | 鼠标 | 10 | 50 |\n| 3 | 键盘 | 5 | 200 |"
  ]
}
```

#### 配置示例 2 - Markdown 格式

```json
{
  "extractMode": "table",
  "headerPattern": "商品名称|数量|单价",
  "format": "markdown"
}
```

**返回 value 示例：**

```markdown
| 序号 | 商品名称 | 数量 | 单价 |
| --- | --- | --- | --- |
| 1 | 笔记本电脑 | 2 | 5000 |
| 2 | 鼠标 | 10 | 50 |
| 3 | 键盘 | 5 | 200 |
```

#### 配置示例 3 - HTML 格式

```json
{
  "extractMode": "table",
  "headerPattern": "商品名称|数量|单价",
  "format": "html"
}
```

**说明：** 返回原始的 HTML 表格代码

---

## 配置参数说明

### 通用参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `extractMode` | String | 否 | 提取模式：`cell`（单元格）或 `table`（整表），默认 `cell` |
| `headerPattern` | String | 是 | 表头特征，用 `\|` 分隔多个关键词，用于识别目标表格 |

### 单元格模式 (`cell`) 参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `targetColumn` | String | 否* | 目标列名（与 `columnIndex` 二选一） |
| `columnIndex` | Integer | 否* | 列索引，从 1 开始（与 `targetColumn` 二选一） |
| `rowMarker` | String | 否 | 行标识关键词，查找包含该关键词的行 |
| `rowIndex` | Integer | 否 | 行索引，从 1 开始 |
| `occurrence` | Integer | 否 | 提取第几个匹配项，默认 1 |
| `returnAll` | Boolean | 否 | 是否返回所有匹配项，默认 false |

### 整表模式 (`table`) 参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `format` | String | 否 | 返回格式：`json`、`markdown` 或 `html`，默认 `json` |

---

## 调试信息

开启调试模式后，`debugInfo` 字段会包含以下信息：

1. **提取模式** - 当前使用的提取模式
2. **表头特征** - 用于匹配的表头关键词
3. **找到的表格数量** - 文档中解析到的表格总数
4. **目标表格表头** - 匹配成功的表格的完整表头
5. **数据行数** - 表格的数据行数（不含表头）
6. **表格预览** - Markdown 格式的表格预览（方便查看）
7. **提取结果** - 提取到的具体内容

### 调试信息示例

```json
"debugInfo": [
  "提取模式: cell",
  "表头特征: 商品名称|数量|单价",
  "找到 1 个表格",
  "找到目标表格，表头: 序号, 商品名称, 数量, 单价, 金额",
  "数据行数: 5",
  "目标列索引: 1 (商品名称)",
  "提取单元格成功: 笔记本电脑",
  "表格预览:\n| 序号 | 商品名称 | 数量 | 单价 | 金额 |\n| --- | --- | --- | --- | --- |\n| 1 | 笔记本电脑 | 2 | 5000 | 10000 |"
]
```

---

## 与旧版本的区别

| 特性 | 旧版本 | 新版本 |
|------|--------|--------|
| 表格识别 | 需要 `tableMarker`（表格标识） | 使用 `headerPattern`（表头特征） |
| 分隔符 | 需要指定 `delimiter` | 不需要（自动解析 HTML） |
| 表格格式 | 纯文本（需要分隔符） | HTML 表格（MinerU 返回） |
| 整表提取 | 不支持 | 支持（JSON/Markdown/HTML） |
| 调试信息 | 基础信息 | 包含表格预览 |
| 表头行识别 | 需要手动指定 `headerRow` | 自动从 `<th>` 或首行提取 |

---

## 常见问题

### Q1: 如果文档中有多个表格怎么办？

A: 使用 `headerPattern` 设置具有区分性的表头关键词。系统会返回第一个匹配的表格。

**示例：**
```json
{
  "headerPattern": "商品名称|数量|单价"  // 匹配采购清单表
}
```

```json
{
  "headerPattern": "收款人|金额|日期"  // 匹配付款记录表
}
```

### Q2: 表格没有 `<th>` 标签怎么办？

A: 系统会自动将第一行作为表头。

### Q3: 如何提取某一列的所有值？

A: 设置 `returnAll: true`，并指定 `targetColumn`。

### Q4: 如何在前端展示表格数据？

A: 使用 `extractMode: "table"` 和 `format: "json"`，返回的 `tableData` 字段包含结构化数据，可以直接用于前端表格组件渲染。

### Q5: 调试信息中的表格预览是什么格式？

A: Markdown 格式，可以直接在支持 Markdown 的编辑器中预览，方便查看表格结构。

---

## 最佳实践

1. **精确匹配表头** - `headerPattern` 应包含目标表格独有的关键词
2. **优先使用列名** - `targetColumn` 比 `columnIndex` 更易维护
3. **开启调试模式** - 开发阶段建议开启，查看表格预览和匹配情况
4. **格式选择**：
   - 前端展示 → `format: "json"`
   - 文档导出 → `format: "markdown"`
   - 原样保留 → `format: "html"`

---

## 技术细节

### HTML 表格解析

系统使用正则表达式解析 HTML 表格：

1. 提取所有 `<table>...</table>` 块
2. 从 `<th>` 或第一个 `<tr>` 提取表头
3. 逐行提取 `<td>` 单元格内容
4. 自动清理 HTML 标签和实体编码

### 表头匹配算法

```
headerPattern = "商品名称|数量|单价"
keywords = ["商品名称", "数量", "单价"]

对于每个表格：
  if 表格表头包含所有 keywords：
    return 该表格
```

---

## 更新日志

**v2.0 (2024-10-09)**
- ✨ 支持 MinerU HTML 表格格式
- ✨ 新增整表提取模式
- ✨ 支持 JSON/Markdown/HTML 三种输出格式
- ✨ 调试信息包含表格预览
- ✨ 智能表头匹配
- 🗑️ 移除 `tableMarker` 和 `delimiter` 配置
- 🗑️ 移除 `headerRow` 配置（自动识别）

---

如有问题，请联系开发团队。

