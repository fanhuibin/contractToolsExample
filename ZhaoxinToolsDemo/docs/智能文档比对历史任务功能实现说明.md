# 智能文档比对历史任务功能实现说明

## 📋 功能概述

修改了智能文档比对的演示文档功能，从"上传新旧文档进行比对"改为"直接查看历史比对结果"。演示文档现在关联已有的比对任务ID，点击后直接跳转到结果页面展示历史比对数据。

## 🎯 实现效果

### 修改前
```
用户点击演示文档
    ↓
系统下载新旧两份PDF文件
    ↓
填充到文件上传区域
    ↓
用户点击"开始比对"
    ↓
等待比对完成
    ↓
查看结果
```

### 修改后
```
用户点击演示文档
    ↓
系统检测到关联的 taskId
    ↓
直接跳转到结果页面
    ↓
显示历史比对结果（无需等待）
```

## 🔧 实现细节

### 1. 后端实现

#### 1.1 DemoDocument 模型添加 taskId 字段

**文件路径**: `ZhaoxinToolsDemo/backend/src/main/java/com/zhaoxin/tools/demo/controller/DemoResourceController.java`

**修改内容**:

##### a) 添加 taskId 字段
```java
@Data
public static class DemoDocument {
    private String id;
    private String name;
    private String filePath;
    private String category;  // extract, compare, compose
    private String templateId;  // 关联的模板ID（用于抽取和合成）
    private String taskId;  // 关联的任务ID（用于比对）
    private String description;
    
    // 构造函数（兼容旧代码）
    public DemoDocument(String id, String name, String filePath, String category, 
                       String templateId, String description) {
        this(id, name, filePath, category, templateId, null, description);
    }
    
    // 新构造函数（支持 taskId）
    public DemoDocument(String id, String name, String filePath, String category, 
                       String templateId, String taskId, String description) {
        this.id = id;
        this.name = name;
        this.filePath = filePath;
        this.category = category;
        this.templateId = templateId;
        this.taskId = taskId;
        this.description = description;
    }
}
```

**说明**:
- 添加了 `taskId` 字段，用于关联历史比对任务
- 提供了两个构造函数，保持向后兼容
- `filePath` 对于比对任务可以为 `null`（不再需要文件）

---

##### b) 修改比对演示文档配置

```java
// 智能文档比对 - 演示文档（关联历史比对任务）
documents.add(new DemoDocument(
    "compare_demo_1",
    "采购合同比对示例",
    null,  // filePath 不再需要
    "compare",
    null,  // templateId 不需要
    "202511_a44df1619ce14a2facb2ebd44cdf8618",  // taskId
    "演示采购合同的版本比对结果"
));

documents.add(new DemoDocument(
    "compare_demo_2",
    "服务协议比对示例",
    null,
    "compare",
    null,
    "202511_31ee983d5936435aa74ec1867dd6b411",  // taskId
    "演示服务协议的版本比对结果"
));
```

**说明**:
- `filePath` 设为 `null`（不再需要下载文件）
- `taskId` 设为写死的历史任务ID
- 两个演示任务ID：
  - `202511_a44df1619ce14a2facb2ebd44cdf8618`
  - `202511_31ee983d5936435aa74ec1867dd6b411`

---

### 2. 前端实现

#### 2.1 Compare.vue 修改文档选择逻辑

**文件路径**: `ZhaoxinToolsDemo/frontend/src/views/Compare.vue`

**修改内容**:

```javascript
// 演示文档选择器（用于比对功能）
const handleDemoDocSelect = async (doc) => {
  console.log('📄 选择演示文档:', doc)
  
  try {
    // 如果文档关联了比对任务ID，直接跳转到结果页面显示历史比对结果
    if (doc.taskId) {
      console.log('🔍 检测到关联任务ID，直接跳转到结果页面:', doc.taskId)
      ElMessage.success(`正在加载比对结果：${doc.name}`)
      router.push(`/compare/result/${doc.taskId}`)
      return
    }
    
    // 以下是旧的逻辑（兼容没有taskId的情况）
    if (!doc.filePath) {
      ElMessage.warning('该演示文档没有关联文件或任务')
      return
    }
    
    // ... 旧的文件加载逻辑（保留兼容性）
  } catch (error) {
    console.error('❌ 加载演示文档失败:', error)
    ElMessage.error('加载演示文档失败：' + (error.message || '未知错误'))
  }
}
```

**说明**:
- **优先检查 `taskId`**: 如果存在，直接跳转到结果页面
- **向后兼容**: 如果没有 `taskId`，仍然使用旧的文件下载逻辑
- **用户体验**: 显示友好的提示消息

---

## 🔄 完整交互流程

### 新流程（有 taskId）

```
用户操作流程：
┌─────────────────────────────────────────────────────────────┐
│ Compare.vue (智能文档比对页面)                               │
│                                                              │
│  1. 用户点击左侧演示文档 "采购合同比对示例"                  │
│     ↓                                                        │
│  2. handleDemoDocSelect(doc) 被触发                          │
│     ↓                                                        │
│  3. 检测到 doc.taskId = "202511_a44df1619ce14a2f..."         │
│     ↓                                                        │
│  4. 显示消息："正在加载比对结果：采购合同比对示例"           │
│     ↓                                                        │
│  5. 直接路由跳转：/compare/result/202511_a44df1619ce14a2f... │
└─────────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│ CompareResult.vue (比对结果页面 - iframe)                    │
│                                                              │
│  6. 加载主系统的比对结果页面                                  │
│     ↓                                                        │
│  7. 显示历史比对结果（差异高亮、统计信息等）                  │
│     ↓                                                        │
│  8. 用户可以查看详细比对、导出报告等                          │
└─────────────────────────────────────────────────────────────┘
```

### 旧流程（无 taskId，向后兼容）

```
用户操作流程：
┌─────────────────────────────────────────────────────────────┐
│ Compare.vue (智能文档比对页面)                               │
│                                                              │
│  1. 用户点击演示文档                                          │
│     ↓                                                        │
│  2. handleDemoDocSelect(doc) 被触发                          │
│     ↓                                                        │
│  3. doc.taskId 为 null，执行旧逻辑                           │
│     ↓                                                        │
│  4. 下载新旧两份PDF文件                                       │
│     ↓                                                        │
│  5. 填充到文件上传区域                                        │
│     ↓                                                        │
│  6. 用户点击"开始比对"                                        │
│     ↓                                                        │
│  7. 提交比对任务，等待完成                                    │
│     ↓                                                        │
│  8. 跳转到结果页面                                            │
└─────────────────────────────────────────────────────────────┘
```

---

## ✅ 测试验证

### 测试步骤

#### 1. 启动服务
```bash
# Demo 后端 (8091)
cd ZhaoxinToolsDemo/backend
mvn spring-boot:run

# Demo 前端 (3004)
cd ZhaoxinToolsDemo/frontend
npm run dev

# 主系统后端 (8080)
cd contract-tools-backend
mvn spring-boot:run

# 主系统前端 (3000)
cd frontend
npm run dev
```

---

#### 2. 测试演示文档接口

访问：`http://localhost:8091/api/demo/documents`

**预期返回**:
```json
{
  "code": 200,
  "message": "操作成功",
  "data": [
    {
      "id": "compare_demo_1",
      "name": "采购合同比对示例",
      "filePath": null,
      "category": "compare",
      "templateId": null,
      "taskId": "202511_a44df1619ce14a2facb2ebd44cdf8618",
      "description": "演示采购合同的版本比对结果"
    },
    {
      "id": "compare_demo_2",
      "name": "服务协议比对示例",
      "filePath": null,
      "category": "compare",
      "templateId": null,
      "taskId": "202511_31ee983d5936435aa74ec1867dd6b411",
      "description": "演示服务协议的版本比对结果"
    }
  ]
}
```

**验证点**:
- ✅ `taskId` 字段存在
- ✅ `taskId` 值正确
- ✅ `filePath` 为 `null`

---

#### 3. 测试前端功能

1. 访问：`http://localhost:3004/compare`
2. 查看左侧演示文档列表
3. **验证**：
   - ✅ 显示 2 个演示文档
   - ✅ 文档名称：
     - "采购合同比对示例"
     - "服务协议比对示例"

4. 点击第一个文档"采购合同比对示例"
5. **验证**：
   - ✅ 显示提示消息："正在加载比对结果：采购合同比对示例"
   - ✅ 页面跳转到：`/compare/result/202511_a44df1619ce14a2facb2ebd44cdf8618`
   - ✅ iframe 显示主系统的比对结果页面
   - ✅ 显示历史比对结果（无需等待）

6. 返回比对页面，点击第二个文档"服务协议比对示例"
7. **验证**：
   - ✅ 跳转到：`/compare/result/202511_31ee983d5936435aa74ec1867dd6b411`
   - ✅ 显示不同的比对结果

---

#### 4. 测试浏览器控制台日志

按 `F12` 打开开发者工具，切换到 Console 标签：

**点击演示文档时的日志**:
```
📄 选择演示文档: {
  id: "compare_demo_1",
  name: "采购合同比对示例",
  taskId: "202511_a44df1619ce14a2facb2ebd44cdf8618",
  ...
}
🔍 检测到关联任务ID，直接跳转到结果页面: 202511_a44df1619ce14a2facb2ebd44cdf8618
```

---

## 🎨 UI 变化

### 演示文档显示

**左侧边栏**：
```
┌─────────────────────────────┐
│ 📋 演示文档                  │
├─────────────────────────────┤
│ 🔴 采购合同比对示例          │  ← 点击后直接看结果
│    演示采购合同的版本比对... │
├─────────────────────────────┤
│ 🔴 服务协议比对示例          │  ← 点击后直接看结果
│    演示服务协议的版本比对... │
└─────────────────────────────┘
```

**说明**:
- 不再显示"原始版 vs 修订版"
- 文档名称更简洁
- 点击后立即跳转，无需上传文件

---

## 💡 技术要点

### 1. 向后兼容设计

```javascript
// 优先检查 taskId
if (doc.taskId) {
  router.push(`/compare/result/${doc.taskId}`)
  return
}

// 没有 taskId 时，使用旧逻辑
if (doc.filePath) {
  // 下载文件并填充...
}
```

**优势**:
- 新旧演示文档可以共存
- 不影响现有代码
- 平滑过渡

---

### 2. 任务ID格式

```
202511_a44df1619ce14a2facb2ebd44cdf8618
└─┬─┘ └──────────┬──────────────────┘
  │              │
  │              └─ UUID（32位十六进制）
  └─ 年月前缀（YYYYMM）
```

**格式说明**:
- `202511`: 年月前缀（2025年11月）
- `_`: 分隔符
- `a44df1619ce14a2facb2ebd44cdf8618`: UUID

---

### 3. 路由跳转

```javascript
router.push(`/compare/result/${doc.taskId}`)
```

**跳转路径**:
```
/compare/result/202511_a44df1619ce14a2facb2ebd44cdf8618
```

**对应的路由配置**（已存在）:
```javascript
{
  path: '/compare/result/:taskId',
  name: 'CompareResult',
  component: CompareResult
}
```

---

## 🔧 如何添加新的演示任务

### 步骤1：创建历史比对任务

在主系统中进行实际的文档比对，获取任务ID：

1. 访问主系统的比对功能
2. 上传新旧两份文档
3. 提交比对任务
4. 复制任务ID（如 `202511_xxx...`）

---

### 步骤2：添加到演示文档列表

修改 `DemoResourceController.java`:

```java
documents.add(new DemoDocument(
    "compare_demo_3",                           // 唯一ID
    "租赁合同比对示例",                          // 显示名称
    null,                                       // filePath 不需要
    "compare",                                  // 分类
    null,                                       // templateId 不需要
    "202511_新的任务ID",                        // 替换为实际任务ID
    "演示租赁合同的版本比对结果"                 // 描述
));
```

---

### 步骤3：重启Demo后端

```bash
cd ZhaoxinToolsDemo/backend
mvn spring-boot:run
```

---

### 步骤4：测试

1. 刷新前端页面
2. 查看左侧演示文档列表
3. 点击新添加的文档
4. 验证是否能正确跳转到结果页面

---

## 📝 注意事项

### 1. 任务ID必须有效

**重要**：演示文档关联的 `taskId` 必须是主系统中真实存在的比对任务ID。

**如何验证**:
```bash
# 访问主系统的任务详情接口
GET http://localhost:8080/api/compare/task/{taskId}
```

**如果任务ID无效**:
- 结果页面会显示"任务不存在"
- 用户无法查看比对结果

---

### 2. 任务不会过期

主系统的比对任务会永久保存（除非手动删除），因此演示任务ID可以长期使用。

---

### 3. 文件存储位置

主系统的比对结果文件存储在：
```
contract-tools-backend/uploads/compare/202511_xxx...
```

**备份建议**:
- 定期备份 `uploads` 目录
- 或者将演示任务的文件单独保存

---

## 🐛 常见问题

### Q1: 点击演示文档后显示"任务不存在"？

**可能原因**:
1. 任务ID不正确
2. 主系统后端未启动
3. 任务文件已被删除

**解决方法**:
1. 检查任务ID是否正确
2. 确认主系统后端正在运行（端口 8080）
3. 重新创建比对任务，获取新的任务ID

---

### Q2: 跳转到结果页面但无法加载？

**可能原因**:
- 主系统前端未启动（端口 3000）
- iframe 无法访问主系统

**解决方法**:
1. 确认主系统前端正在运行
2. 检查浏览器控制台是否有 CORS 错误
3. 检查 iframe 的 URL 是否正确

---

### Q3: 如何切换回上传文件模式？

**方法1**: 点击"新建任务"按钮

**方法2**: 将演示文档的 `taskId` 设为 `null`，并提供 `filePath`：
```java
documents.add(new DemoDocument(
    "compare_demo_custom",
    "自定义比对",
    "demo/compare/文件1.pdf|demo/compare/文件2.pdf",  // 提供文件路径
    "compare",
    null,
    null,  // taskId 为 null
    "自定义上传文件进行比对"
));
```

---

## 📊 数据结构对比

### 修改前（文件模式）
```json
{
  "id": "compare_demo_1",
  "name": "合同比对示例（原始版 vs 修订版）",
  "filePath": "demo/compare/合同-原始版.pdf|demo/compare/合同-修订版.pdf",
  "category": "compare",
  "templateId": null,
  "taskId": null,  // ← 没有 taskId
  "description": "演示合同版本对比：包含原始版和修订版两份文档"
}
```

### 修改后（任务模式）
```json
{
  "id": "compare_demo_1",
  "name": "采购合同比对示例",
  "filePath": null,  // ← 不需要文件
  "category": "compare",
  "templateId": null,
  "taskId": "202511_a44df1619ce14a2facb2ebd44cdf8618",  // ← 有 taskId
  "description": "演示采购合同的版本比对结果"
}
```

---

## 🎉 总结

✅ **已实现**:
1. 演示文档支持关联历史比对任务ID
2. 点击演示文档后直接跳转到结果页面
3. 无需上传文件，无需等待比对
4. 保持向后兼容（支持旧的文件上传模式）

✅ **优势**:
- **即时查看**: 点击即看，无需等待
- **用户体验**: 流程更简洁，操作更流畅
- **演示效果**: 展示真实的比对结果
- **易于维护**: 只需配置任务ID

✅ **灵活性**:
- 可以随时添加新的演示任务
- 可以混合使用文件模式和任务模式
- 向后兼容，不影响现有功能

🎊 **功能已完整实现！**

