# 自定义字段快速测试指南

## 🚀 快速开始

### 1. 启动服务（按顺序）

```bash
# ① 主系统后端 (8080)
cd contract-tools-backend
mvn spring-boot:run

# ② 主系统前端 (3000)
cd frontend
npm run dev

# ③ Demo 后端 (8091)
cd ZhaoxinToolsDemo/backend
mvn spring-boot:run

# ④ Demo 前端 (3004)
cd ZhaoxinToolsDemo/frontend
npm run dev
```

---

## 🧪 测试步骤

### 步骤 1：测试自定义字段接口

打开浏览器访问：
```
http://localhost:8091/api/custom-fields/config?templateType=default
```

**✅ 预期结果**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "baseFields": [
      {
        "tag": "contract_no",
        "name": "合同编号",
        "type": "text",
        ...
      }
    ],
    "clauseFields": [...],
    "counterpartyFields": [...],
    "sealFields": [...]
  }
}
```

---

### 步骤 2：测试模板设计器集成

1. 访问：`http://localhost:3004/compose-main`
2. 点击左侧"**模板管理**"按钮
3. 在模板列表中，点击任意模板的"**设计模板**"按钮
4. 查看设计器左侧的字段面板

**✅ 预期结果**：

左侧显示 4 个字段分类标签：
- 📋 基础字段
- 📄 条款字段
- 👥 相对方字段
- 🔖 印章字段

点击"**基础字段**"标签，应该看到：
- ✅ 合同编号
- ✅ 合同名称
- ✅ 签订日期
- ✅ 签订地点
- ✅ 合同金额
- ✅ 生效日期
- ✅ 到期日期

**❌ 不应该看到系统默认字段（如果看到说明配置未生效）**

---

### 步骤 3：测试字段插入

1. 在设计器左侧点击任意字段（如"合同编号"）
2. 在弹出的对话框中输入自定义名称（可选）
3. 点击"插入"按钮
4. 在 Word 文档中应该看到插入的 ContentControl

**✅ 预期结果**：
- 字段成功插入到文档中
- ContentControl 显示为灰色背景的占位符
- 右侧"已插入元素"列表中显示该字段

---

### 步骤 4：测试不同模板类型

#### 测试采购合同字段

修改 `ComposeMain.vue` 第 359-361 行：

```javascript
const fieldsConfigUrl = encodeURIComponent(
  `${ZHAOXIN_CONFIG.demoBaseUrl}/api/custom-fields/config?templateType=purchase`
)
```

重启 Demo 前端，重新测试步骤 2-3。

**✅ 预期结果**：
- 基础字段应该显示："采购合同编号"、"采购日期"、"采购总额" 等
- 相对方字段应该显示："采购方名称"、"供应商名称" 等

#### 测试服务协议字段

```javascript
const fieldsConfigUrl = encodeURIComponent(
  `${ZHAOXIN_CONFIG.demoBaseUrl}/api/custom-fields/config?templateType=service`
)
```

**✅ 预期结果**：
- 基础字段应该显示："协议编号"、"服务类型"、"服务费用" 等
- 相对方字段应该显示："委托方名称"、"服务方名称" 等

---

## 🔍 调试检查点

### 浏览器控制台日志

在浏览器按 `F12` 打开开发者工具，切换到 Console 标签，应该看到以下日志：

#### 1. 打开模板管理时
```
🌐 构建iframe URL: http://localhost:3000/templates?fieldsConfigUrl=http%3A%2F%2Flocalhost%3A8091%2Fapi%2Fcustom-fields%2Fconfig%3FtemplateType%3Ddefault&embed=true&hideBack=true
```

#### 2. 点击"设计模板"时
```
📋 传递自定义字段配置URL: http://localhost:8091/api/custom-fields/config?templateType=default
```

#### 3. 设计器加载字段时
```
[自定义字段] 从外部URL加载配置: http://localhost:8091/api/custom-fields/config?templateType=default
[自定义字段] 成功加载自定义字段，共 XX 个基础字段
```

### 网络请求检查

在浏览器开发者工具的 Network 标签中，应该看到：

1. **请求 URL**：
   ```
   http://localhost:8091/api/custom-fields/config?templateType=default
   ```

2. **请求方法**：`GET`

3. **响应状态**：`200 OK`

4. **响应头**：
   ```
   Access-Control-Allow-Origin: http://localhost:3000
   Content-Type: application/json
   ```

---

## ❓ 常见问题

### Q1: 字段面板仍然显示系统默认字段？

**可能原因**：
1. Demo 后端未启动（8091 端口）
2. CORS 配置未生效
3. URL 编码错误

**解决方法**：
1. 检查 Demo 后端是否正常运行：访问 `http://localhost:8091/api/custom-fields/config`
2. 检查浏览器控制台是否有 CORS 错误
3. 清除浏览器缓存，刷新页面

---

### Q2: 网络请求失败，提示 CORS 错误？

**错误信息**：
```
Access to fetch at 'http://localhost:8091/api/custom-fields/config' 
from origin 'http://localhost:3000' has been blocked by CORS policy
```

**解决方法**：
1. 确认 `WebConfig.java` 中的 CORS 配置已正确设置
2. 重启 Demo 后端
3. 清除浏览器缓存

---

### Q3: 接口返回 404 错误？

**可能原因**：
- Controller 未正确注册
- 请求 URL 错误

**解决方法**：
1. 检查 `CustomFieldsController.java` 的 `@RestController` 和 `@RequestMapping` 注解
2. 确认请求 URL 是 `/api/custom-fields/config`
3. 重新编译并启动 Demo 后端

---

### Q4: 字段显示为空或不完整？

**可能原因**：
- 字段配置返回的 JSON 格式错误
- 字段分类名称不匹配

**解决方法**：
1. 在浏览器中直接访问接口，检查返回的 JSON 格式
2. 确认字段的 `category` 字段正确：`base`、`clause`、`party`、`seal`
3. 检查浏览器控制台是否有 JavaScript 错误

---

## 📋 测试清单

打印此清单，逐项测试：

- [ ] Demo 后端已启动（8091）
- [ ] Demo 前端已启动（3004）
- [ ] 主系统后端已启动（8080）
- [ ] 主系统前端已启动（3000）
- [ ] 接口测试通过：`http://localhost:8091/api/custom-fields/config`
- [ ] 返回 JSON 包含 4 个字段分类
- [ ] 能打开模板管理对话框
- [ ] 能打开模板设计器
- [ ] 设计器左侧显示自定义字段
- [ ] 能成功插入字段到文档
- [ ] 浏览器控制台无 CORS 错误
- [ ] Network 标签显示字段配置请求成功（200）

---

## 🎉 测试成功标志

如果所有测试项通过，您应该能看到：

1. ✅ 设计器左侧显示 Demo 后端定义的自定义字段
2. ✅ 字段按 4 个分类正确分组
3. ✅ 可以成功插入字段到模板
4. ✅ 浏览器控制台无错误日志
5. ✅ 切换 `templateType` 后显示不同字段集

**恭喜！自定义字段配置功能已成功实现！** 🎊

---

## 📖 下一步

- 查看完整文档：[自定义字段配置功能实现说明](./自定义字段配置功能实现说明.md)
- 了解如何添加新字段
- 了解如何创建新的模板类型
- 了解高级配置选项


