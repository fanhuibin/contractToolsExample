# åˆåŒåˆæˆæ¨¡æ¿ç®¡ç†åŠŸèƒ½å®ç°è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æœ¬æ¬¡å®ç°äº†æ™ºèƒ½åˆåŒåˆæˆæ¨¡å—çš„æ¨¡æ¿ç®¡ç†åŠŸèƒ½ï¼Œå…è®¸ç”¨æˆ·é€šè¿‡ iframe åµŒå…¥ä¸»ç³»ç»Ÿçš„æ¨¡æ¿ç®¡ç†ç•Œé¢æ¥ç®¡ç†åˆåŒæ¨¡æ¿ã€‚

## ğŸ¯ å®ç°å†…å®¹

### 1. ComposeMain.vue - ä¿®å¤æ¨¡æ¿ç®¡ç†URL

**æ–‡ä»¶è·¯å¾„**: `ZhaoxinToolsDemo/frontend/src/views/ComposeMain.vue`

**ä¿®æ”¹å†…å®¹**:
```javascript
// ä¿®æ”¹å‰ï¼ˆé”™è¯¯ï¼‰
const templateManageUrl = computed(() => {
  return `${ZHAOXIN_CONFIG.frontendUrl}/templates/compose`
})

// ä¿®æ”¹åï¼ˆæ­£ç¡®ï¼‰
const templateManageUrl = computed(() => {
  return `${ZHAOXIN_CONFIG.frontendUrl}/templates`
})
```

**è¯´æ˜**: 
- å°†æ¨¡æ¿ç®¡ç†URLæŒ‡å‘æ­£ç¡®çš„è·¯ç”± `/templates`
- è¯¥è·¯ç”±å¯¹åº”ä¸»ç³»ç»Ÿçš„ `TemplatesLibrary.vue` ç»„ä»¶

---

### 2. TemplatesLibrary.vue - æ·»åŠ  Embed æ¨¡å¼æ”¯æŒ

**æ–‡ä»¶è·¯å¾„**: `frontend/src/views/templates/TemplatesLibrary.vue`

#### ä¿®æ”¹å†…å®¹

##### a) æ·»åŠ  Embed æ¨¡å¼æ£€æµ‹
```typescript
import { useRouter, useRoute } from 'vue-router'

const route = useRoute()
const isEmbedMode = computed(() => route.query.embed === 'true')
```

##### b) ä¿®æ”¹è¿”å›æŒ‰é’®é€»è¾‘
```typescript
function goBack() {
  if (isEmbedMode.value) {
    // Embed æ¨¡å¼ï¼šå‘é€å…³é—­æ¶ˆæ¯ç»™çˆ¶çª—å£
    console.log('ğŸ”™ [åµŒå…¥æ¨¡å¼] å…³é—­æ¨¡æ¿ç®¡ç† iframe')
    window.parent.postMessage({
      type: 'NAVIGATE_BACK',
      source: 'zhaoxin-sdk',
      payload: {
        from: '/templates',
        timestamp: Date.now()
      }
    }, '*')
  } else {
    // ç‹¬ç«‹æ¨¡å¼ï¼šè·³è½¬åˆ°æ™ºèƒ½åˆåŒåˆæˆé¡µé¢
    router.push('/smart-compose')
  }
}
```

##### c) ä¿®æ”¹è®¾è®¡æ¨¡æ¿è·³è½¬é€»è¾‘
```typescript
function openDesigner(row: any) {
  const query: any = { 
    id: row.id || row.templateId, 
    fileId: row.fileId,
    returnUrl: '/templates'
  }
  
  // Embed æ¨¡å¼ä¸‹ï¼Œä¿æŒ embed å‚æ•°
  if (isEmbedMode.value) {
    query.embed = 'true'
    query.hideBack = 'true'
  }
  
  router.push({ 
    path: '/template-design', 
    query 
  }) 
}
```

**è¯´æ˜**:
- åœ¨ iframe åµŒå…¥æ¨¡å¼ä¸‹ï¼Œç‚¹å‡»"è¿”å›"æŒ‰é’®ä¼šå‘é€ `postMessage` ç»™çˆ¶çª—å£ï¼Œç”±çˆ¶çª—å£çš„ `IframeDialog` ç»„ä»¶æ¥æ”¶å¹¶å…³é—­å¯¹è¯æ¡†
- åœ¨ iframe åµŒå…¥æ¨¡å¼ä¸‹ï¼Œç‚¹å‡»"è®¾è®¡æ¨¡æ¿"ä¼šä¿æŒ `embed=true` å‚æ•°ï¼Œç¡®ä¿è®¾è®¡å™¨ä¹Ÿåœ¨ iframe å†…æ‰“å¼€

---

### 3. TemplateDesign.vue - æ·»åŠ  Embed æ¨¡å¼æ”¯æŒ

**æ–‡ä»¶è·¯å¾„**: `frontend/src/views/templates/TemplateDesign.vue`

#### ä¿®æ”¹å†…å®¹

##### a) æ·»åŠ  Embed æ¨¡å¼æ£€æµ‹
```typescript
const isEmbedMode = computed(() => route.query.embed === 'true')
```

##### b) ä¿®æ”¹è¿”å›é€»è¾‘
```typescript
function goBack() {
  // Embed æ¨¡å¼ï¼šä¿æŒ embed å’Œ hideBack å‚æ•°
  if (isEmbedMode.value) {
    router.push({
      path: returnUrl.value,
      query: {
        embed: 'true',
        hideBack: 'true'
      }
    })
  } else {
    // ç‹¬ç«‹æ¨¡å¼ï¼šæ­£å¸¸è·³è½¬
    router.push(returnUrl.value)
  }
}
```

**è¯´æ˜**:
- åœ¨è®¾è®¡å™¨ä¸­ç‚¹å‡»"è¿”å›"æ—¶ï¼Œå¦‚æœæ˜¯ embed æ¨¡å¼ï¼Œä¼šä¿æŒ `embed=true` å’Œ `hideBack=true` å‚æ•°
- è¿™æ ·è¿”å›åˆ°æ¨¡æ¿åˆ—è¡¨æ—¶ä»ç„¶ä¿æŒåœ¨ iframe å†…éƒ¨ï¼Œä¸ä¼šè·³å‡º

---

### 4. IframeDialog.vue - å·²æ”¯æŒ postMessage ç›‘å¬

**æ–‡ä»¶è·¯å¾„**: `ZhaoxinToolsDemo/frontend/src/components/IframeDialog.vue`

**ç°æœ‰åŠŸèƒ½**:
```javascript
const handleMessage = (event) => {
  // éªŒè¯æ¶ˆæ¯æ¥æº
  if (event.origin !== ZHAOXIN_CONFIG.frontendUrl) {
    console.warn('âš ï¸ å¿½ç•¥æ¥è‡ªæœªçŸ¥æ¥æºçš„æ¶ˆæ¯:', event.origin)
    return
  }
  
  // å¤„ç†å¯¼èˆªè¿”å›æ¶ˆæ¯
  if (event.data?.type === 'NAVIGATE_BACK' && 
      event.data?.source === 'zhaoxin-sdk') {
    console.log('âœ… æ”¶åˆ°è¿”å›æ¶ˆæ¯ï¼Œå…³é—­å¼¹çª—', event.data.payload)
    handleClose()
  }
}
```

**è¯´æ˜**:
- `IframeDialog` ç»„ä»¶å·²ç»å®ç°äº† `postMessage` ç›‘å¬
- å½“æ¥æ”¶åˆ° `NAVIGATE_BACK` æ¶ˆæ¯æ—¶ï¼Œä¼šè‡ªåŠ¨å…³é—­å¯¹è¯æ¡†

---

## ğŸ”„ å®Œæ•´äº¤äº’æµç¨‹

```
ç”¨æˆ·æ“ä½œæµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ComposeMain.vue (åˆåŒåˆæˆä¸»é¡µé¢)                             â”‚
â”‚                                                              â”‚
â”‚  1. ç”¨æˆ·ç‚¹å‡»"æ¨¡æ¿ç®¡ç†"æŒ‰é’®                                    â”‚
â”‚     â†“                                                        â”‚
â”‚  2. æ‰“å¼€ IframeDialogï¼ŒåµŒå…¥ /templates?embed=true            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TemplatesLibrary.vue (æ¨¡æ¿åˆ—è¡¨ - iframe å†…)                  â”‚
â”‚                                                              â”‚
â”‚  3. ç”¨æˆ·ç‚¹å‡»"è®¾è®¡æ¨¡æ¿"                                        â”‚
â”‚     â†“                                                        â”‚
â”‚  4. è·³è½¬åˆ° /template-design?embed=true&hideBack=true         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TemplateDesign.vue (æ¨¡æ¿è®¾è®¡å™¨ - iframe å†…)                  â”‚
â”‚                                                              â”‚
â”‚  5. ç”¨æˆ·è®¾è®¡å®Œæˆï¼Œç‚¹å‡»"è¿”å›"                                  â”‚
â”‚     â†“                                                        â”‚
â”‚  6. è·³è½¬å› /templates?embed=true&hideBack=true (ä»åœ¨iframeå†…) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TemplatesLibrary.vue (æ¨¡æ¿åˆ—è¡¨ - iframe å†…)                  â”‚
â”‚                                                              â”‚
â”‚  7. ç”¨æˆ·æŸ¥çœ‹æ¨¡æ¿åˆ—è¡¨ï¼Œç‚¹å‡»"è¿”å›"                              â”‚
â”‚     â†“                                                        â”‚
â”‚  8. å‘é€ postMessage(NAVIGATE_BACK) ç»™çˆ¶çª—å£                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IframeDialog (çˆ¶çª—å£)                                        â”‚
â”‚                                                              â”‚
â”‚  9. æ¥æ”¶åˆ° NAVIGATE_BACK æ¶ˆæ¯                                â”‚
â”‚     â†“                                                        â”‚
â”‚ 10. å…³é—­å¯¹è¯æ¡†ï¼Œè¿”å› ComposeMain.vue                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… æµ‹è¯•æ­¥éª¤

### 1. å¯åŠ¨æœåŠ¡
```bash
# å¯åŠ¨ä¸»ç³»ç»Ÿåç«¯ (ç«¯å£ 8080)
cd contract-tools-backend
mvn spring-boot:run

# å¯åŠ¨ä¸»ç³»ç»Ÿå‰ç«¯ (ç«¯å£ 3000)
cd frontend
npm run dev

# å¯åŠ¨ Demo åç«¯ (ç«¯å£ 8091)
cd ZhaoxinToolsDemo/backend
mvn spring-boot:run

# å¯åŠ¨ Demo å‰ç«¯ (ç«¯å£ 3004)
cd ZhaoxinToolsDemo/frontend
npm run dev
```

### 2. è®¿é—®æµ‹è¯•

1. æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`http://localhost:3004`
2. ç‚¹å‡»"æ™ºèƒ½åˆåŒåˆæˆ"å¡ç‰‡
3. ç‚¹å‡»å·¦ä¾§è¾¹æ çš„"æ¨¡æ¿ç®¡ç†"æŒ‰é’®
4. éªŒè¯ï¼š
   - âœ… æ‰“å¼€æ¨¡æ¿ç®¡ç†å¯¹è¯æ¡†ï¼ˆiframeï¼‰
   - âœ… æ˜¾ç¤ºæ¨¡æ¿åˆ—è¡¨
   - âœ… ç‚¹å‡»"è®¾è®¡æ¨¡æ¿"è¿›å…¥è®¾è®¡å™¨ï¼ˆä»åœ¨ iframe å†…ï¼‰
   - âœ… åœ¨è®¾è®¡å™¨ä¸­ç‚¹å‡»"è¿”å›"å›åˆ°æ¨¡æ¿åˆ—è¡¨ï¼ˆä»åœ¨ iframe å†…ï¼‰
   - âœ… åœ¨æ¨¡æ¿åˆ—è¡¨ä¸­ç‚¹å‡»"è¿”å›"å…³é—­å¯¹è¯æ¡†

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [é›†æˆæ™ºèƒ½åˆåŒåˆæˆ](http://localhost:3000/doc-center?doc=integration-compose)
- [è‡ªå®šä¹‰å…ƒç´ ä½¿ç”¨æŒ‡å—](http://localhost:3000/doc-center?doc=custom-fields-guide)

---

## ğŸ¨ å›¾æ ‡é¢œè‰²ä¿®æ”¹ï¼ˆé¢å¤–ä¼˜åŒ–ï¼‰

### æ–‡ä»¶å¤¹å›¾æ ‡é¢œè‰²è°ƒæ•´

**æ–‡ä»¶è·¯å¾„**: `ZhaoxinToolsDemo/frontend/src/views/ComposeMain.vue`

**ä¿®æ”¹å†…å®¹**:
```scss
.placeholder-icon {
  color: #909399;  // ä» #409EFFï¼ˆè“è‰²ï¼‰æ”¹ä¸ºç°è‰²
}
```

**è¯´æ˜**: å°†"è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæ¼”ç¤ºæ¨¡æ¿"æç¤ºåŒºåŸŸçš„æ–‡ä»¶å¤¹å›¾æ ‡é¢œè‰²ä»è“è‰²æ”¹ä¸ºç°è‰²ï¼Œä½¿ç•Œé¢æ›´åŠ æŸ”å’Œã€ç»Ÿä¸€ã€‚

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

1. **æ¨¡æ¿åŒæ­¥**ï¼š
   - å½“ç”¨æˆ·åœ¨æ¨¡æ¿ç®¡ç†ä¸­ä¿®æ”¹æ¨¡æ¿åï¼Œè‡ªåŠ¨åˆ·æ–° ComposeMain ä¸­çš„æ¨¡æ¿åˆ—è¡¨
   - å¯ä»¥åœ¨ `onTemplateDialogClose` äº‹ä»¶ä¸­è°ƒç”¨ `loadTemplates()`ï¼ˆå·²å®ç°ï¼‰

2. **æƒé™æ§åˆ¶**ï¼š
   - æ ¹æ®ç”¨æˆ·æƒé™æ§åˆ¶"æ–°å»ºæ¨¡æ¿"ã€"åˆ é™¤æ¨¡æ¿"ç­‰æ“ä½œçš„å¯è§æ€§
   - åœ¨ Demo æ¨¡å¼ä¸‹å¯èƒ½éœ€è¦ç¦ç”¨æŸäº›æ“ä½œ

3. **é”™è¯¯å¤„ç†**ï¼š
   - å¢å¼ºé”™è¯¯æç¤ºï¼Œä¾‹å¦‚å½“æ¨¡æ¿æ–‡ä»¶ä¸å­˜åœ¨æ—¶ç»™å‡ºæ›´å‹å¥½çš„æç¤º
   - æ·»åŠ ç½‘ç»œå¼‚å¸¸çš„é‡è¯•æœºåˆ¶

---

## âš™ï¸ æŠ€æœ¯è¦ç‚¹

### 1. postMessage è·¨çª—å£é€šä¿¡

```javascript
// å­çª—å£ï¼ˆiframeï¼‰å‘é€æ¶ˆæ¯
window.parent.postMessage({
  type: 'NAVIGATE_BACK',
  source: 'zhaoxin-sdk',
  payload: { ... }
}, '*')

// çˆ¶çª—å£æ¥æ”¶æ¶ˆæ¯
window.addEventListener('message', (event) => {
  if (event.data?.type === 'NAVIGATE_BACK') {
    // å¤„ç†è¿”å›é€»è¾‘
  }
})
```

### 2. URL Query å‚æ•°ä¼ é€’

```javascript
// æ„å»ºå¸¦å‚æ•°çš„ URL
const query = {
  id: '123',
  embed: 'true',
  hideBack: 'true'
}

router.push({
  path: '/templates',
  query
})

// è¯»å–å‚æ•°
const isEmbedMode = computed(() => route.query.embed === 'true')
```

### 3. IframeDialog è‡ªåŠ¨æ·»åŠ å‚æ•°

```javascript
const iframeUrl = computed(() => {
  const url = new URL(props.url, ZHAOXIN_CONFIG.frontendUrl)
  url.searchParams.set('embed', 'true')
  url.searchParams.set('hideBack', 'true')
  return url.toString()
})
```

---

## ğŸ“ æ€»ç»“

æœ¬æ¬¡å®ç°å®Œæˆäº†åˆåŒåˆæˆæ¨¡æ¿ç®¡ç†åŠŸèƒ½çš„ iframe é›†æˆï¼Œä¸»è¦åŒ…æ‹¬ï¼š

1. âœ… ä¿®å¤äº†æ¨¡æ¿ç®¡ç†URLï¼ˆä» `/templates/compose` æ”¹ä¸º `/templates`ï¼‰
2. âœ… åœ¨ `TemplatesLibrary.vue` ä¸­æ·»åŠ äº† embed æ¨¡å¼æ”¯æŒ
3. âœ… åœ¨ `TemplateDesign.vue` ä¸­æ·»åŠ äº† embed æ¨¡å¼æ”¯æŒ
4. âœ… ç¡®ä¿äº† `IframeDialog` çš„ postMessage é€šä¿¡æ­£å¸¸å·¥ä½œ
5. âœ… ä¼˜åŒ–äº†å›¾æ ‡é¢œè‰²ï¼Œä½¿ç•Œé¢æ›´åŠ ç»Ÿä¸€

ç”¨æˆ·ç°åœ¨å¯ä»¥åœ¨ Demo ç³»ç»Ÿä¸­ï¼š
- é€šè¿‡"æ¨¡æ¿ç®¡ç†"æŒ‰é’®æ‰“å¼€æ¨¡æ¿åˆ—è¡¨ï¼ˆiframeï¼‰
- åœ¨ iframe å†…åˆ›å»ºã€ç¼–è¾‘ã€ç®¡ç†æ¨¡æ¿
- ç‚¹å‡»"è®¾è®¡æ¨¡æ¿"è¿›å…¥è®¾è®¡å™¨ï¼ˆä»åœ¨ iframe å†…ï¼‰
- å®Œæˆæ“ä½œåé€šè¿‡"è¿”å›"æŒ‰é’®å…³é—­ iframe

æ•´ä¸ªæµç¨‹æµç•…è‡ªç„¶ï¼Œç”¨æˆ·ä½“éªŒè‰¯å¥½ï¼ğŸ‰

