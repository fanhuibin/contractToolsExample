# æ—¥å¿—ä¼˜åŒ–è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

**åŸé—®é¢˜**ï¼š
- æœåŠ¡å™¨ç¯å¢ƒæ—¥å¿—è¿‡å¤šï¼Œä¸å¤Ÿå‹å¥½
- 502é”™è¯¯æ—¶æ‰“å°å¤§ç‰‡HTMLä¿¡æ¯ï¼ˆnginxé”™è¯¯é¡µé¢ï¼‰
- å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒæ—¥å¿—çº§åˆ«æœªåŒºåˆ†
- HTTPé”™è¯¯å“åº”å†…å®¹å†—é•¿

## âœ… ä¼˜åŒ–æ–¹æ¡ˆ

### 1. ç¯å¢ƒåŒºåˆ†çš„æ—¥å¿—é…ç½®

#### å¼€å‘ç¯å¢ƒ (`application.yml`)
```yaml
logging:
  level:
    root: INFO
    com.zhaoxin.tools.demo: DEBUG
    # æ§åˆ¶HTTPå®¢æˆ·ç«¯è¯¦ç»†æ—¥å¿—
    org.springframework.web.client.RestTemplate: WARN
    org.springframework.web.client.HttpServerErrorException: ERROR
  file:
    name: logs/zhaoxin-demo-dev.log
    max-size: 50MB
    max-history: 7
```

#### ç”Ÿäº§ç¯å¢ƒ (`application-prod.yml`)
```yaml
logging:
  level:
    root: WARN  # æ›´ä¸¥æ ¼çš„æ—¥å¿—çº§åˆ«
    com.zhaoxin.tools.demo: INFO
    # HTTPå®¢æˆ·ç«¯æ—¥å¿—æ§åˆ¶ï¼ˆå…³é”®ï¼šé¿å…502é”™è¯¯çš„HTMLå†…å®¹æ‰“å°ï¼‰
    org.springframework.web.client.RestTemplate: ERROR
    org.springframework.web.client.HttpServerErrorException: ERROR
    org.springframework.web.client.RestClientException: ERROR
  pattern:
    console: "%d{MM-dd HH:mm:ss} %-5level %logger{36} - %msg%n"  # ç®€åŒ–æ ¼å¼
  console:
    threshold: WARN  # æ§åˆ¶å°åªæ˜¾ç¤ºè­¦å‘ŠåŠä»¥ä¸Šçº§åˆ«
```

### 2. HTTPé”™è¯¯å¤„ç†ä¼˜åŒ–

#### LoggingConfig.java - RestTemplateæ‹¦æˆªå™¨
```java
@Configuration
public class LoggingConfig {
    
    @Bean
    public RestTemplate restTemplate() {
        RestTemplate restTemplate = new RestTemplate();
        
        // æ·»åŠ æ‹¦æˆªå™¨ï¼Œæ§åˆ¶æ—¥å¿—è¾“å‡º
        interceptors.add((request, body, execution) -> {
            try {
                log.info("HTTPè¯·æ±‚: {} {}", request.getMethod(), request.getURI());
                var response = execution.execute(request, body);
                log.info("HTTPå“åº”: {} - {}", response.getStatusCode().value(), 
                        response.getStatusCode().getReasonPhrase());
                return response;
            } catch (Exception e) {
                // åªè®°å½•å…³é”®é”™è¯¯ä¿¡æ¯ï¼Œä¸æ‰“å°HTMLå†…å®¹
                if (errorMsg.contains("<!DOCTYPE html>")) {
                    log.error("HTTPè¯·æ±‚å¤±è´¥: {} {} - æœåŠ¡å™¨è¿”å›é”™è¯¯é¡µé¢", 
                            request.getMethod(), request.getURI());
                }
            }
        });
    }
}
```

#### GlobalExceptionHandler.java - å…¨å±€å¼‚å¸¸å¤„ç†
```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(HttpServerErrorException.class)
    public ResponseEntity<Map<String, Object>> handleHttpServerError(HttpServerErrorException e) {
        // åªè®°å½•å…³é”®ä¿¡æ¯ï¼Œä¸æ‰“å°HTMLå†…å®¹
        log.error("å¤–éƒ¨APIè°ƒç”¨å¤±è´¥: {} - {}", e.getStatusCode(), e.getStatusText());
        
        Map<String, Object> response = new HashMap<>();
        response.put("success", false);
        response.put("message", "å¤–éƒ¨æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•");
        return ResponseEntity.status(HttpStatus.SERVICE_UNAVAILABLE).body(response);
    }
}
```

### 3. æ—¥å¿—çº§åˆ«æ§åˆ¶

| ç»„ä»¶ | å¼€å‘ç¯å¢ƒ | ç”Ÿäº§ç¯å¢ƒ | è¯´æ˜ |
|------|----------|----------|------|
| **root** | INFO | WARN | æ ¹æ—¥å¿—çº§åˆ« |
| **ä¸šåŠ¡ä»£ç ** | DEBUG | INFO | ä¸šåŠ¡é€»è¾‘æ—¥å¿— |
| **Springæ¡†æ¶** | WARN | WARN | æ¡†æ¶æ—¥å¿— |
| **HTTPå®¢æˆ·ç«¯** | WARN | ERROR | é¿å…502é”™è¯¯è¯¦æƒ… |
| **Tomcat** | ERROR | ERROR | æœåŠ¡å™¨æ—¥å¿— |

## ğŸ“Š ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰ âŒ
```
2025-11-13 18:03:01 [http-nio-8091-exec-5] ERROR o.s.w.c.RestTemplate - 
org.springframework.web.client.HttpServerErrorException$BadGateway: 502 Bad Gateway: 
"<!DOCTYPE html>
<html>
<head><title>502 Bad Gateway</title></head>
<body>
<center><h1>502 Bad Gateway</h1></center>
<hr><center>nginx/1.18.0</center>
</body>
</html>
<!-- a padding to disable MSIE and Chrome friendly error page -->
<!-- a padding to disable MSIE and Chrome friendly error page -->
<!-- a padding to disable MSIE and Chrome friendly error page -->
..."
```

### ä¿®å¤å âœ…
```
11-13 18:03:01 ERROR GlobalExceptionHandler - å¤–éƒ¨APIè°ƒç”¨å¤±è´¥: 502 - Bad Gateway
11-13 18:03:01 INFO  CompareController - æ¯”å¯¹è¯·æ±‚å¤„ç†å¤±è´¥ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯ç»™ç”¨æˆ·
```

## ğŸ¯ å…³é”®æ”¹è¿›

### 1. **HTMLå†…å®¹è¿‡æ»¤**
- æ£€æµ‹å“åº”ä¸­çš„ `<!DOCTYPE html>` æ ‡è¯†
- é¿å…æ‰“å°å®Œæ•´çš„HTMLé”™è¯¯é¡µé¢
- åªè®°å½•çŠ¶æ€ç å’Œå…³é”®ä¿¡æ¯

### 2. **æ—¥å¿—æ ¼å¼ä¼˜åŒ–**
- **å¼€å‘ç¯å¢ƒ**ï¼šè¯¦ç»†æ ¼å¼ï¼ŒåŒ…å«çº¿ç¨‹ä¿¡æ¯
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šç®€åŒ–æ ¼å¼ï¼Œåªæ˜¾ç¤ºæ—¶é—´ã€çº§åˆ«ã€ç±»åã€æ¶ˆæ¯

### 3. **æ§åˆ¶å°è¾“å‡ºæ§åˆ¶**
- **å¼€å‘ç¯å¢ƒ**ï¼šæ˜¾ç¤ºæ‰€æœ‰INFOåŠä»¥ä¸Šæ—¥å¿—
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šåªæ˜¾ç¤ºWARNåŠä»¥ä¸Šæ—¥å¿—

### 4. **æ–‡ä»¶æ—¥å¿—ç®¡ç†**
- **å¼€å‘ç¯å¢ƒ**ï¼š7å¤©å†å²ï¼Œ50MBè½®è½¬
- **ç”Ÿäº§ç¯å¢ƒ**ï¼š15å¤©å†å²ï¼Œ50MBè½®è½¬

## ğŸš€ éƒ¨ç½²åæ•ˆæœ

### ç”Ÿäº§ç¯å¢ƒæ—¥å¿—ç¤ºä¾‹
```
11-13 18:03:01 INFO  CompareController - æ”¶åˆ°æ¯”å¯¹è¯·æ±‚
11-13 18:03:01 ERROR GlobalExceptionHandler - å¤–éƒ¨APIè°ƒç”¨å¤±è´¥: 502 - Bad Gateway
11-13 18:03:01 INFO  CompareController - è¿”å›é”™è¯¯å“åº”ç»™ç”¨æˆ·
```

### å¼€å‘ç¯å¢ƒæ—¥å¿—ç¤ºä¾‹
```
2025-11-13 18:03:01 [http-nio-8091-exec-5] DEBUG CompareController - å¤„ç†æ¯”å¯¹è¯·æ±‚: {...}
2025-11-13 18:03:01 [http-nio-8091-exec-5] INFO  LoggingConfig - HTTPè¯·æ±‚: POST http://192.168.0.10:8080/api/compare-pro/submit-url
2025-11-13 18:03:01 [http-nio-8091-exec-5] ERROR LoggingConfig - HTTPè¯·æ±‚å¤±è´¥: POST http://192.168.0.10:8080/api/compare-pro/submit-url - æœåŠ¡å™¨è¿”å›é”™è¯¯é¡µé¢
```

## ğŸ“‹ ä½¿ç”¨æŒ‡å—

### 1. é‡æ–°æ„å»ºé¡¹ç›®
```bash
echo 1 | .\build.bat
```

### 2. éƒ¨ç½²åˆ°æœåŠ¡å™¨
```bash
# ä¸Šä¼ æ–°çš„éƒ¨ç½²åŒ…
scp zhaoxin-demo-linux.zip user@server:/opt/

# é‡æ–°éƒ¨ç½²
cd /opt/
unzip -o zhaoxin-demo-linux.zip
cd zhaoxin-demo-linux/
./deploy-linux.sh
```

### 3. æŸ¥çœ‹ä¼˜åŒ–åçš„æ—¥å¿—
```bash
# æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ï¼ˆç®€æ´ï¼‰
docker logs zhaoxin-demo-backend

# æŸ¥çœ‹æ–‡ä»¶æ—¥å¿—ï¼ˆè¯¦ç»†ï¼‰
tail -f /opt/zhaoxin-demo-linux/logs/application.log
```

## ğŸ”§ è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### 1. æ—¥å¿—ç›‘æ§
- å¯ä»¥é›†æˆELK Stackè¿›è¡Œæ—¥å¿—åˆ†æ
- è®¾ç½®å…³é”®é”™è¯¯çš„å‘Šè­¦æœºåˆ¶

### 2. æ€§èƒ½ç›‘æ§
- æ·»åŠ HTTPè¯·æ±‚è€—æ—¶ç»Ÿè®¡
- ç›‘æ§APIè°ƒç”¨æˆåŠŸç‡

### 3. é…ç½®å¤–éƒ¨åŒ–
- é€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶æ—¥å¿—çº§åˆ«
- æ”¯æŒè¿è¡Œæ—¶åŠ¨æ€è°ƒæ•´æ—¥å¿—é…ç½®

## ğŸ‰ æ€»ç»“

é€šè¿‡è¿™æ¬¡æ—¥å¿—ä¼˜åŒ–ï¼š

- âœ… **ç¯å¢ƒåŒºåˆ†** - å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨ä¸åŒçš„æ—¥å¿—ç­–ç•¥
- âœ… **å†…å®¹è¿‡æ»¤** - é¿å…æ‰“å°HTMLé”™è¯¯é¡µé¢å†…å®¹
- âœ… **çº§åˆ«æ§åˆ¶** - ç”Ÿäº§ç¯å¢ƒä½¿ç”¨æ›´ä¸¥æ ¼çš„æ—¥å¿—çº§åˆ«
- âœ… **æ ¼å¼ä¼˜åŒ–** - ç®€åŒ–ç”Ÿäº§ç¯å¢ƒçš„æ—¥å¿—æ ¼å¼
- âœ… **å¼‚å¸¸å¤„ç†** - ç»Ÿä¸€å¤„ç†HTTPå¼‚å¸¸ï¼Œæä¾›å‹å¥½çš„é”™è¯¯ä¿¡æ¯

ç°åœ¨æœåŠ¡å™¨ç¯å¢ƒçš„æ—¥å¿—æ›´åŠ ç®€æ´ã€å‹å¥½ï¼Œä¾¿äºè¿ç»´ç®¡ç†ï¼ğŸš€
