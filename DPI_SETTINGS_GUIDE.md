# DPI 设置指南 - 提高前端显示清晰度

## 问题描述

前端比对结果显示的图片不清晰，原因是 PDF 转图片时的 DPI 设置太低（150-160 DPI）。

## 解决方案

### 1. 修改配置文件

**位置**: `contract-tools-sdk/src/main/resources/application.yml`

```yaml
zxcm:
  compare:
    zxocr:
      # 图像处理配置
      render-dpi: 300  # 从 150 提高到 300
```

### 2. DPI 设置说明

| DPI 值 | 清晰度 | 文件大小 | 适用场景 | 推荐 |
|--------|--------|----------|----------|------|
| **150** | 较低 | 小 (~200KB) | 快速预览、测试 | ❌ 不推荐 |
| **160** | 较低 | 小 (~250KB) | 移动端预览 | ❌ 不推荐 |
| **200** | 中等 | 中 (~400KB) | 标准办公场景 | ⚠️ 可用 |
| **300** | 高清 | 中大 (~800KB) | **前端展示（推荐）** | ✅ **推荐** |
| **400** | 超高清 | 大 (~1.5MB) | 专业审核、打印 | ⚠️ 按需 |
| **600** | 印刷级 | 很大 (~3MB) | 专业印刷 | ❌ 太大 |

### 3. 推荐配置

#### 方案 A：前端展示（推荐）
```yaml
render-dpi: 300  # 高清显示，文件大小适中
```
- ✅ 清晰度高，适合屏幕查看
- ✅ 文件大小适中（A4 单页约 800KB）
- ✅ 性能影响小

#### 方案 B：高性能场景
```yaml
render-dpi: 200  # 标准清晰度，更快速
```
- ⚠️ 清晰度一般
- ✅ 文件更小，加载更快
- ✅ 适合移动端或网络较慢的情况

#### 方案 C：专业审核
```yaml
render-dpi: 400  # 超高清，用于细节审查
```
- ✅ 清晰度极高，能看清所有细节
- ⚠️ 文件较大（A4 单页约 1.5MB）
- ⚠️ 生成和加载速度较慢

## 重要：清理缓存图片

**修改 DPI 后，必须清理旧的缓存图片，否则仍会使用旧的低清晰度图片！**

### 清理步骤

1. **停止应用**
   ```bash
   # 停止正在运行的服务
   ```

2. **删除缓存的图片文件**
   ```bash
   # 删除比对结果目录中的图片
   rm -rf ./uploads/compare-pro/results/*/ocr/images/
   rm -rf ./uploads/compare-pro/tasks/*/ocr/images/
   
   # Windows PowerShell
   Remove-Item -Recurse -Force .\uploads\compare-pro\results\*\ocr\images\
   Remove-Item -Recurse -Force .\uploads\compare-pro\tasks\*\ocr\images\
   ```

3. **重启应用**
   ```bash
   # 重新启动服务，新的 DPI 设置会生效
   ```

4. **重新执行比对**
   - 重新上传文档并执行比对
   - 系统会使用新的 300 DPI 生成高清图片

## 图片缓存机制说明

### 当前缓存逻辑

代码中有图片缓存机制（`MinerUOCRService.java` 第 220-245 行）：

```java
// 如果图片已存在且可读取，直接复用
if (imageFile.exists()) {
    image = ImageIO.read(imageFile);
    if (image != null) {
        log.debug("复用已有图片: {}", imageFile.getName());
        cachedCount++;
    }
}
```

### 缓存的优缺点

**优点**：
- ✅ 避免重复生成，节省时间
- ✅ 同一 PDF 多次比对更快

**缺点**：
- ⚠️ 修改 DPI 后，旧图片不会自动更新
- ⚠️ 需要手动清理才能生效

## 验证清晰度

### 方法 1：检查图片尺寸

```bash
# 查看生成的图片信息
ls -lh ./uploads/compare-pro/results/*/ocr/images/page-1.png

# 预期结果（A4 页面）：
# 150 DPI: 约 1240 x 1754 像素，~200KB
# 200 DPI: 约 1654 x 2339 像素，~400KB
# 300 DPI: 约 2480 x 3508 像素，~800KB  ← 推荐
# 400 DPI: 约 3307 x 4677 像素，~1.5MB
```

### 方法 2：前端查看

1. 执行新的比对任务
2. 在前端查看比对结果
3. 放大图片，检查文字边缘是否清晰
4. 小号字体应该能清晰辨认

## 性能影响分析

### 图片生成时间（A4 单页）

| DPI | 生成时间 | 相对差异 |
|-----|---------|---------|
| 150 | ~0.3s | 基准 |
| 200 | ~0.5s | +67% |
| 300 | ~0.8s | +167% |
| 400 | ~1.2s | +300% |

### 内存占用（A4 单页）

| DPI | 内存占用 | 相对差异 |
|-----|---------|---------|
| 150 | ~6MB | 基准 |
| 200 | ~11MB | +83% |
| 300 | ~25MB | +317% |
| 400 | ~44MB | +633% |

### 推荐配置建议

**对于 10 页 PDF**：
- **150 DPI**: 生成时间 ~3s，总大小 ~2MB
- **300 DPI**: 生成时间 ~8s，总大小 ~8MB ← **推荐**
- **400 DPI**: 生成时间 ~12s，总大小 ~15MB

**服务器配置建议**：
- 内存：建议至少 4GB 可用内存
- CPU：多核 CPU 可加速处理
- 存储：确保有足够空间（100 页约 80MB @ 300 DPI）

## 配置生效检查

### 1. 检查日志

启动应用后，查看日志中的 DPI 设置：

```
开始生成10个页面图片，DPI: 300
```

### 2. 检查图片分辨率

```bash
# Linux/Mac
file ./uploads/compare-pro/results/*/ocr/images/page-1.png

# 应该显示：
# PNG image data, 2480 x 3508, 8-bit/color RGB
#                ^^^^   ^^^^  这是 300 DPI 的尺寸（A4）
```

### 3. 前端验证

- 在前端打开比对结果
- 右键点击图片 → 查看图片信息
- 图片尺寸应该是约 2480 x 3508 像素（A4 @ 300 DPI）

## 常见问题

### Q1: 修改了配置但图片还是不清晰？

**A**: 必须清理缓存图片并重新生成！

```bash
# 删除所有缓存图片
rm -rf ./uploads/compare-pro/results/*/ocr/images/
```

### Q2: DPI 太高会不会影响性能？

**A**: 300 DPI 是平衡点，影响不大：
- 生成时间增加约 2-3 倍（但通常只需几秒）
- 文件大小增加约 4 倍（但现代浏览器可以轻松处理）
- 内存占用增加约 4 倍（PDFBox 处理后会释放）

### Q3: 可以动态设置 DPI 吗？

**A**: 可以通过环境变量覆盖：

```bash
# 启动时设置
export ZXCM_COMPARE_ZXOCR_RENDER_DPI=300
java -jar your-app.jar

# 或者使用 Spring Boot 参数
java -jar your-app.jar --zxcm.compare.zxocr.render-dpi=300
```

### Q4: 不同的比对任务可以使用不同的 DPI 吗？

**A**: 目前是全局配置，所有任务使用相同 DPI。如需不同设置，可以：
1. 为重要文档临时提高 DPI
2. 重启应用并清理缓存
3. 处理完后恢复默认设置

## 总结

✅ **推荐配置**：
```yaml
render-dpi: 300  # 高清显示，适合前端展示
```

✅ **必做步骤**：
1. 修改配置文件
2. **删除缓存图片**
3. 重启应用
4. 重新执行比对

✅ **验证方法**：
- 检查日志中的 DPI 值
- 查看图片文件大小（约 800KB/页）
- 前端放大查看清晰度

---

**修改完成后，前端显示的图片将清晰度提升近 4 倍！** 🎉

